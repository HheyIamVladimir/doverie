<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–î–æ–≤–µ—Ä–∏–µ</title>
<style>
/* ===== –¢–ï–ú–´ ===== */
:root {
    --bg: #0f0f0f;
    --surface: #1a1a1a;
    --surface2: #242424;
    --accent: #ff6600;
    --accent2: #ff8833;
    --text: #f0f0f0;
    --text-muted: #777;
    --border: #2a2a2a;
    --msg-my-bg: #ff6600;
    --msg-my-color: #fff;
    --msg-their-bg: #242424;
    --msg-their-color: #f0f0f0;
    --header-bg: #141414;
}
[data-theme="light"] {
    --bg: #f5f5f5;
    --surface: #ffffff;
    --surface2: #efefef;
    --accent: #ff6600;
    --accent2: #ff8833;
    --text: #111;
    --text-muted: #888;
    --border: #ddd;
    --msg-my-bg: #ff6600;
    --msg-my-color: #fff;
    --msg-their-bg: #e8e8e8;
    --msg-their-color: #111;
    --header-bg: #fff;
}
[data-theme="neon"] {
    --bg: #05050f;
    --surface: #0c0c20;
    --surface2: #131330;
    --accent: #00ffcc;
    --accent2: #ff00ff;
    --text: #e0ffe0;
    --text-muted: #446644;
    --border: #1a1a40;
    --msg-my-bg: #00ffcc;
    --msg-my-color: #000;
    --msg-their-bg: #131330;
    --msg-their-color: #e0ffe0;
    --header-bg: #080818;
}
[data-theme="ocean"] {
    --bg: #060e18;
    --surface: #0d1e30;
    --surface2: #122840;
    --accent: #0099ff;
    --accent2: #00ccff;
    --text: #d0eeff;
    --text-muted: #3a6080;
    --border: #0d2540;
    --msg-my-bg: #0099ff;
    --msg-my-color: #fff;
    --msg-their-bg: #122840;
    --msg-their-color: #d0eeff;
    --header-bg: #081422;
}
[data-theme="matrix"] {
    --bg: #000;
    --surface: #0a0a0a;
    --surface2: #111;
    --accent: #00ff41;
    --accent2: #00cc33;
    --text: #00ff41;
    --text-muted: #005515;
    --border: #001a00;
    --msg-my-bg: #003300;
    --msg-my-color: #00ff41;
    --msg-their-bg: #0a0a0a;
    --msg-their-color: #00ff41;
    --header-bg: #050505;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Courier New', monospace;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    justify-content: center;
}

.app {
    width: 100%;
    max-width: 600px;
    height: 100dvh;
    display: flex;
    flex-direction: column;
    background: var(--surface);
    position: relative;
    overflow: hidden;
}

.screen {
    display: none;
    flex-direction: column;
    flex: 1;
    overflow: hidden;
}
.screen.active { display: flex; }

.header {
    background: var(--header-bg);
    border-bottom: 1px solid var(--border);
    padding: 10px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    min-height: 54px;
    flex-shrink: 0;
}
.header-title {
    font-size: 0.95rem;
    font-weight: bold;
    letter-spacing: 0.08em;
    flex: 1;
}

button {
    cursor: pointer;
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 10px;
    font-family: inherit;
    font-size: 0.88rem;
    font-weight: bold;
    letter-spacing: 0.05em;
    padding: 11px 16px;
    transition: opacity 0.15s, transform 0.1s;
}
button:active { transform: scale(0.97); opacity: 0.85; }
button.sec { background: var(--surface2); color: var(--text); }
button.ghost { background: none; color: var(--text-muted); padding: 7px 10px; }
button.danger { background: #e53935; color: #fff; }

input, textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: inherit;
    font-size: 0.93rem;
    padding: 11px 13px;
    outline: none;
    transition: border-color 0.2s;
}
input:focus, textarea:focus { border-color: var(--accent); }

/* AUTH */
#auth-screen {
    align-items: center;
    justify-content: center;
    padding: 24px 20px;
    background: var(--bg);
}
.auth-box { width: 100%; max-width: 360px; display: flex; flex-direction: column; gap: 12px; }
.auth-logo { text-align: center; font-size: 2.2rem; font-weight: bold; letter-spacing: 0.15em; color: var(--accent); }
.auth-logo small { color: var(--text-muted); font-size: 0.7rem; display: block; letter-spacing: 0.2em; margin-top: 4px; }
.auth-tabs { display: flex; background: var(--surface2); border-radius: 10px; overflow: hidden; }
.auth-tab { flex: 1; background: none; color: var(--text-muted); border-radius: 0; font-size: 0.82rem; padding: 10px; }
.auth-tab.active { background: var(--accent); color: #fff; }
.auth-msg { font-size: 0.8rem; color: #e53935; text-align: center; min-height: 16px; }

/* LIST */
.tabs { display: flex; background: var(--header-bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
.tab { flex: 1; background: none; color: var(--text-muted); border-radius: 0; font-size: 0.75rem; padding: 11px 4px; letter-spacing: 0.07em; border-bottom: 2px solid transparent; }
.tab.active { color: var(--accent); border-bottom-color: var(--accent); }

.search-row { padding: 9px 11px; background: var(--header-bg); border-bottom: 1px solid var(--border); display: flex; gap: 7px; flex-shrink: 0; align-items: flex-start; }
.search-row input { margin: 0; }
.search-row button { width: auto; padding: 10px 13px; flex-shrink: 0; }
.search-col { flex-direction: column; gap: 8px; }
.search-col-row { display: flex; gap: 7px; width: 100%; }
.search-col-row input { margin: 0; flex: 1; }
.search-col-row button { flex-shrink: 0; width: auto; padding: 10px 13px; }

.list-body { flex: 1; overflow-y: auto; }
.chat-item { display: flex; align-items: center; gap: 11px; padding: 11px 13px; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.1s; }
.chat-item:active { background: var(--surface2); }
.av { width: 44px; height: 44px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: bold; color: #fff; flex-shrink: 0; overflow: hidden; }
.av img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.ci { flex: 1; min-width: 0; }
.ci-name { font-size: 0.92rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ci-sub { font-size: 0.76rem; color: var(--text-muted); margin-top: 2px; }
.unread-badge { background: var(--accent); color: #fff; border-radius: 20px; font-size: 0.7rem; font-weight: bold; padding: 2px 7px; flex-shrink: 0; }
.empty-hint { text-align: center; color: var(--text-muted); padding: 50px 20px; font-size: 0.83rem; line-height: 1.9; }

/* CHAT */
.chat-hav { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 0.95rem; font-weight: bold; color: #fff; flex-shrink: 0; overflow: hidden; cursor: pointer; }
.chat-hav img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.chat-hinfo { flex: 1; min-width: 0; }
.chat-hname { font-size: 0.92rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.chat-hstatus { font-size: 0.73rem; color: var(--text-muted); }
.chat-hstatus.online { color: #4caf50; }

.chat-history { flex: 1; overflow-y: auto; padding: 11px; display: flex; flex-direction: column; gap: 5px; background: var(--bg); }
.mw { display: flex; flex-direction: column; }
.mw.my { align-items: flex-end; }
.mw.their { align-items: flex-start; }
.ms { font-size: 0.7rem; color: var(--accent2); margin-bottom: 2px; padding: 0 3px; }
.mb { max-width: 78%; padding: 8px 12px; border-radius: 13px; font-size: 0.91rem; line-height: 1.45; word-break: break-word; }
.mw.my .mb { background: var(--msg-my-bg); color: var(--msg-my-color); border-bottom-right-radius: 3px; }
.mw.their .mb { background: var(--msg-their-bg); color: var(--msg-their-color); border-bottom-left-radius: 3px; }
.mt { font-size: 0.67rem; opacity: 0.55; margin-top: 3px; text-align: right; }
.msg-photo { max-width: 200px; border-radius: 9px; display: block; margin-bottom: 3px; cursor: pointer; }

.input-area { padding: 9px 11px; background: var(--header-bg); border-top: 1px solid var(--border); display: flex; gap: 7px; align-items: center; flex-shrink: 0; }
.input-area input { margin: 0; flex: 1; padding: 10px 13px; }
.input-area button { width: auto; padding: 10px 13px; flex-shrink: 0; }

/* PROFILE */
.prof-body { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 14px; background: var(--bg); }
.prof-av { width: 80px; height: 80px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: bold; color: #fff; margin: 0 auto; overflow: hidden; cursor: pointer; }
.prof-av img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.prof-name { text-align: center; font-size: 1.05rem; font-weight: bold; }
.prof-bio { text-align: center; color: var(--text-muted); font-size: 0.83rem; }
.sec-title { font-size: 0.73rem; color: var(--text-muted); letter-spacing: 0.1em; }

/* THEMES */
.theme-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 7px; }
.theme-btn { aspect-ratio: 1; border-radius: 11px; border: 2px solid transparent !important; cursor: pointer; font-size: 0.6rem; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; padding: 5px 3px; letter-spacing: 0; background: none; color: inherit; transition: border-color 0.2s; }
.theme-btn.sel { border-color: var(--accent) !important; }

/* CHANNEL */
.post-card { background: var(--surface2); border-radius: 13px; padding: 13px; margin-bottom: 9px; }
.post-author { font-size: 0.76rem; color: var(--accent2); margin-bottom: 5px; }
.post-text { font-size: 0.91rem; line-height: 1.5; }
.post-img { width: 100%; border-radius: 9px; margin: 7px 0; cursor: pointer; display: block; }
.post-time { font-size: 0.7rem; color: var(--text-muted); margin-top: 5px; }

/* TOAST */
.toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: var(--surface2); color: var(--text); border: 1px solid var(--border); border-radius: 20px; padding: 9px 20px; font-size: 0.83rem; z-index: 9999; white-space: nowrap; max-width: 88vw; pointer-events: none; }
.toast.ok { border-color: #4caf50; color: #4caf50; }
.toast.err { border-color: #e53935; color: #e53935; }

/* MODAL */
.modal-ov { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 2000; display: flex; align-items: flex-end; justify-content: center; }
.modal-box { background: var(--surface); border-radius: 18px 18px 0 0; padding: 18px; width: 100%; max-width: 600px; display: flex; flex-direction: column; gap: 11px; max-height: 80dvh; overflow-y: auto; }
.modal-head { display: flex; align-items: center; justify-content: space-between; }
.modal-title { font-size: 0.95rem; font-weight: bold; }

/* PHOTO */
.photo-ov { position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 5000; display: flex; align-items: center; justify-content: center; }
.photo-ov img { max-width: 95vw; max-height: 90dvh; border-radius: 9px; }

::-webkit-scrollbar { width: 3px; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>
<div class="app" id="app">

<!-- AUTH -->
<div id="s-auth" class="screen active">
    <div class="auth-box">
        <div class="auth-logo">–î–û–í–ï–†–ò–ï<small>–ú–ï–°–°–ï–ù–î–ñ–ï–†</small></div>
        <div class="auth-tabs">
            <button class="auth-tab active" id="atab-login" onclick="setAuthMode('login')">–í–•–û–î</button>
            <button class="auth-tab" id="atab-reg" onclick="setAuthMode('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
        </div>
        <input id="aName" type="text" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º" autocomplete="off" autocorrect="off" autocapitalize="off" onkeydown="if(event.key==='Enter')doAuth()">
        <input id="aPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')doAuth()">
        <div id="aMsg" class="auth-msg"></div>
        <button id="aBtn" onclick="doAuth()">–í–û–ô–¢–ò</button>
    </div>
</div>

<!-- MAIN LIST -->
<div id="s-main" class="screen">
    <div class="header">
        <button class="ghost" id="profBtn" onclick="go('s-profile')" style="font-size:1.15rem;">üë§</button>
        <div class="header-title" id="mainTitle">–ß–ê–¢–´</div>
        <button class="ghost" onclick="go('s-settings')" style="font-size:1.15rem;">‚öôÔ∏è</button>
    </div>
    <div class="tabs">
        <button class="tab active" id="tab-chats" onclick="switchTab('chats')">üí¨ –ß–ê–¢–´</button>
        <button class="tab" id="tab-groups" onclick="switchTab('groups')">üë• –ì–†–£–ü–ü–´</button>
        <button class="tab" id="tab-channels" onclick="switchTab('channels')">üì¢ –ö–ê–ù–ê–õ–´</button>
    </div>
    <div id="sr-chats" class="search-row">
        <input id="searchUser" placeholder="–ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É..." autocorrect="off" autocapitalize="off" onkeydown="if(event.key==='Enter')findUser()">
        <button onclick="findUser()">üîç</button>
    </div>
    <div id="sr-groups" class="search-row search-col" style="display:none;">
        <div class="search-col-row">
            <input id="searchGrp" placeholder="ID –≥—Ä—É–ø–ø—ã (GRP-XXXXX)..." autocorrect="off" autocapitalize="off">
            <button onclick="joinGrpById()">‚ûï</button>
        </div>
        <button class="sec" style="width:100%;" onclick="showCreateGrp()">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>
    <div id="sr-channels" class="search-row search-col" style="display:none;">
        <div class="search-col-row">
            <input id="searchChan" placeholder="ID –∫–∞–Ω–∞–ª–∞ (D-XXXX)..." autocorrect="off" autocapitalize="off">
            <button onclick="subChanById()">‚ûï</button>
        </div>
        <button class="sec" style="width:100%;" onclick="showCreateChan()">+ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
    </div>
    <div class="list-body" id="listBody"></div>
</div>

<!-- CHAT -->
<div id="s-chat" class="screen">
    <div class="header">
        <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
        <div class="chat-hav" id="chatAv" onclick="openViewedProfile()">?</div>
        <div class="chat-hinfo">
            <div class="chat-hname" id="chatName">–ß–ê–¢</div>
            <div class="chat-hstatus" id="chatStatus"></div>
        </div>
    </div>
    <div class="chat-history" id="chatHist"></div>
    <div class="input-area">
        <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="sendPhoto(this)">
        <button class="ghost" onclick="document.getElementById('photoInput').click()" style="font-size:1.1rem;">üìé</button>
        <input id="msgIn" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendMsg()">
        <button onclick="sendMsg()">‚û§</button>
    </div>
</div>

<!-- CHANNEL VIEW -->
<div id="s-channel" class="screen">
    <div class="header">
        <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
        <div class="header-title" id="chanTitle">–ö–ê–ù–ê–õ</div>
        <button class="ghost" id="postBtn" style="display:none;" onclick="showPostModal()">‚úèÔ∏è</button>
    </div>
    <div class="list-body" id="chanBody" style="padding:11px;"></div>
</div>

<!-- MY PROFILE -->
<div id="s-profile" class="screen">
    <div class="header">
        <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
        <div class="header-title">–ú–û–ô –ü–†–û–§–ò–õ–¨</div>
        <button class="danger" onclick="logout()" style="font-size:0.75rem; padding:7px 11px;">–í–´–ô–¢–ò</button>
    </div>
    <div class="prof-body">
        <div class="prof-av" id="myAv" onclick="pickAvatar()">?</div>
        <div class="prof-name" id="myName"></div>
        <div style="text-align:center;font-size:0.75rem;color:var(--text-muted);" id="myIdLabel"></div>
        <div style="display:flex;flex-direction:column;gap:7px;">
            <div class="sec-title">–ë–ò–û</div>
            <textarea id="myBio" placeholder="–û —Å–µ–±–µ..." rows="3" style="resize:none;"></textarea>
            <button onclick="saveBio()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        </div>
        <div style="display:flex;flex-direction:column;gap:7px;">
            <div class="sec-title">–°–ú–ï–ù–ò–¢–¨ –ò–ú–Ø</div>
            <input id="newName" placeholder="–ù–æ–≤—ã–π —é–∑–µ—Ä–Ω–µ–π–º..." autocorrect="off" autocapitalize="off">
            <button onclick="changeUsername()">–°–ú–ï–ù–ò–¢–¨</button>
        </div>
    </div>
</div>

<!-- SETTINGS -->
<div id="s-settings" class="screen">
    <div class="header">
        <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
        <div class="header-title">–ù–ê–°–¢–†–û–ô–ö–ò</div>
    </div>
    <div class="prof-body">
        <div class="sec-title">–¢–ï–ú–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø</div>
        <div class="theme-grid" id="themeGrid"></div>
    </div>
</div>

<!-- USER PROFILE VIEW -->
<div id="s-uprofile" class="screen">
    <div class="header">
        <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
        <div class="header-title">–ü–†–û–§–ò–õ–¨</div>
    </div>
    <div class="prof-body">
        <div class="prof-av" id="upAv" style="cursor:default;">?</div>
        <div class="prof-name" id="upName"></div>
        <div class="prof-bio" id="upBio"></div>
        <button onclick="msgViewedUser()">üí¨ –ù–ê–ü–ò–°–ê–¢–¨</button>
    </div>
</div>

</div>

<script>
// === STATE ===
let myId = null, myUser = null;
let tab = 'chats';
let targetId = null, targetName = null, chatType = 'direct';
let grpId = null, chanId = null;
let msgInt = null, statInt = null;
let authMode = 'login';
let hist = []; // screen history
let upId = null, upName = null; // viewed user profile

// === THEMES ===
const THEMES = [
    {id:'dark',   name:'–¢–Å–ú–ù–ê–Ø',  bg:'#0f0f0f', ac:'#ff6600'},
    {id:'light',  name:'–°–í–ï–¢–õ–ê–Ø', bg:'#f5f5f5', ac:'#ff6600'},
    {id:'neon',   name:'–ù–ï–û–ù',    bg:'#05050f', ac:'#00ffcc'},
    {id:'ocean',  name:'–û–ö–ï–ê–ù',   bg:'#060e18', ac:'#0099ff'},
    {id:'matrix', name:'–ú–ê–¢–†–ò–¶–ê', bg:'#000',    ac:'#00ff41'},
];

(function initTheme() {
    const t = localStorage.getItem('th') || 'dark';
    document.documentElement.setAttribute('data-theme', t);
})();

function renderThemes() {
    const cur = localStorage.getItem('th') || 'dark';
    document.getElementById('themeGrid').innerHTML = THEMES.map(t =>
        `<button class="theme-btn${t.id===cur?' sel':''}"
            style="background:${t.bg};color:${t.ac};border-color:${t.id===cur?t.ac:'transparent'} !important;"
            onclick="applyTheme('${t.id}')">
            <span style="font-size:1rem;">‚óè</span>${t.name}
        </button>`
    ).join('');
}

function applyTheme(id) {
    localStorage.setItem('th', id);
    document.documentElement.setAttribute('data-theme', id);
    renderThemes();
    toast('–¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞');
}

// === NAVIGATION ===
function go(id) {
    const cur = document.querySelector('.screen.active');
    if (cur && cur.id !== id) hist.push(cur.id);
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function goBack() {
    stopChat();
    const prev = hist.pop() || 's-main';
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(prev).classList.add('active');
    if (prev === 's-main') refreshTab();
}

function stopChat() {
    clearInterval(msgInt);
    clearInterval(statInt);
    msgInt = null; statInt = null;
}

// === TOAST ===
function toast(msg, type='') {
    document.querySelectorAll('.toast').forEach(t => t.remove());
    const el = document.createElement('div');
    el.className = 'toast' + (type==='ok' ? ' ok' : type==='err' ? ' err' : '');
    el.textContent = msg;
    document.getElementById('app').appendChild(el);
    setTimeout(() => el.remove(), 2400);
}

// === API ===
async function post(url, body) {
    const r = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    return r.json();
}
async function get(url) {
    return (await fetch(url)).json();
}

// === AUTH ===
function setAuthMode(m) {
    authMode = m;
    document.getElementById('atab-login').classList.toggle('active', m==='login');
    document.getElementById('atab-reg').classList.toggle('active', m==='reg');
    document.getElementById('aBtn').textContent = m==='login' ? '–í–û–ô–¢–ò' : '–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø';
    document.getElementById('aMsg').textContent = '';
}

async function doAuth() {
    const username = document.getElementById('aName').value.trim();
    const password = document.getElementById('aPass').value;
    const msg = document.getElementById('aMsg');
    if (!username || !password) { msg.textContent = '–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è'; return; }

    try {
        if (authMode === 'reg') {
            if (username.length < 2) { msg.textContent = '–ò–º—è –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞'; return; }
            if (!/^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]+$/.test(username)) { msg.textContent = '–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _'; return; }
            const r = await post('/api/register', {username, password});
            if (!r.success) { msg.textContent = r.error==='taken' ? '–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ' : '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏'; return; }
            myId = r.id; myUser = r.displayName;
        } else {
            const r = await post('/api/login', {username, password});
            if (!r.success) { msg.textContent = r.error==='banned' ? '–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å'; return; }
            myId = r.id; myUser = r.username;
        }
        localStorage.setItem('_id', myId);
        localStorage.setItem('_un', myUser);
        onLogin();
    } catch(e) {
        msg.textContent = '–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
    }
}

function onLogin() {
    hist = [];
    startPing();
    loadMyProfile();
    go('s-main');
    switchTab('chats');
}

function startPing() {
    const ping = () => post('/api/ping', {userId:myId}).catch(()=>{});
    ping();
    setInterval(ping, 20000);
}

// === TABS ===
function switchTab(t) {
    tab = t;
    ['chats','groups','channels'].forEach(x => {
        document.getElementById('tab-'+x).classList.toggle('active', x===t);
        const sr = document.getElementById('sr-'+x);
        if (sr) sr.style.display = x===t ? 'flex' : 'none';
    });
    document.getElementById('mainTitle').textContent = t==='chats' ? '–ß–ê–¢–´' : t==='groups' ? '–ì–†–£–ü–ü–´' : '–ö–ê–ù–ê–õ–´';
    refreshTab();
}

function refreshTab() {
    if (tab==='chats') loadChats();
    else if (tab==='groups') loadGroups();
    else loadChannels();
}

// === CHATS ===
async function loadChats() {
    const b = document.getElementById('listBody');
    b.innerHTML = '<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
        const list = await get(`/api/chats/${myId}`);
        if (!list.length) { b.innerHTML = '<div class="empty-hint">–ù–µ—Ç —á–∞—Ç–æ–≤.<br>–ù–∞–π–¥–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É ‚Üë</div>'; return; }
        b.innerHTML = list.map(c => `
            <div class="chat-item" onclick="openChat('${c.id}','${esc(c.username)}')">
                ${avHtml(c.username, c.avatar, 44)}
                <div class="ci">
                    <div class="ci-name">${esc(c.username)}</div>
                    <div class="ci-sub">${c.online ? 'üü¢ –æ–Ω–ª–∞–π–Ω' : '‚ö´ –æ—Ñ—Ñ–ª–∞–π–Ω'}</div>
                </div>
                ${c.unread > 0 ? `<div class="unread-badge">${c.unread>99?'99+':c.unread}</div>` : ''}
            </div>`).join('');
    } catch(e) { b.innerHTML = '<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

async function findUser() {
    const u = document.getElementById('searchUser').value.trim().replace(/^@/,'');
    if (!u) return;
    try {
        const r = await get(`/api/user/find/${encodeURIComponent(u)}`);
        if (!r.id) { toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','err'); return; }
        document.getElementById('searchUser').value = '';
        openChat(r.id, r.username);
    } catch(e) { toast('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞','err'); }
}

function openChat(id, name) {
    stopChat();
    targetId = id; targetName = name; chatType = 'direct'; grpId = null;
    document.getElementById('chatName').textContent = name;
    document.getElementById('chatStatus').textContent = '';
    document.getElementById('chatStatus').className = 'chat-hstatus';
    setAv('chatAv', id, name);
    go('s-chat');
    loadMsgs();
    updateStat();
    msgInt = setInterval(loadMsgs, 2500);
    statInt = setInterval(updateStat, 15000);
}

function setAv(elId, id, name) {
    const el = document.getElementById(elId);
    const cached = id ? localStorage.getItem('av_'+id) : null;
    if (cached) { el.innerHTML = `<img src="${cached}">`; }
    else { el.innerHTML = ''; el.textContent = (name||'?')[0].toUpperCase(); el.style.background = strColor(name); }
}

async function updateStat() {
    if (!targetId || chatType !== 'direct') return;
    try {
        const r = await get(`/api/status/${targetId}`);
        const el = document.getElementById('chatStatus');
        el.className = 'chat-hstatus' + (r.online ? ' online' : '');
        el.textContent = r.online ? '‚óè –æ–Ω–ª–∞–π–Ω' : (r.lastSeen ? `–±—ã–ª(–∞) ${ago(r.lastSeen)}` : '–æ—Ñ—Ñ–ª–∞–π–Ω');
    } catch(e) {}
}

async function loadMsgs() {
    const url = chatType==='group' && grpId
        ? `/api/group-messages/${grpId}`
        : (targetId ? `/api/messages/${myId}/${targetId}` : null);
    if (!url) return;
    try {
        const msgs = await get(url);
        const h = document.getElementById('chatHist');
        const atBottom = h.scrollHeight - h.scrollTop <= h.clientHeight + 80;
        h.innerHTML = msgs.length
            ? msgs.map(m => renderMsg(m)).join('')
            : '<div class="empty-hint">üëã –ù–∞–ø–∏—à–∏ –ø–µ—Ä–≤—ã–º!</div>';
        if (atBottom) h.scrollTop = h.scrollHeight;
    } catch(e) {}
}

function renderMsg(m) {
    const mine = m.fromId === myId;
    const sender = !mine && chatType==='group' ? `<div class="ms">${esc(m.fromName||m.fromId)}</div>` : '';
    const photo = m.photo ? `<img class="msg-photo" src="${m.photo}" onclick="viewPhoto('${m.photo}')">` : '';
    return `<div class="mw ${mine?'my':'their'}">
        ${sender}
        <div class="mb">${photo}${m.text?esc(m.text):''}<div class="mt">${m.time?fmtTime(m.time):''}</div></div>
    </div>`;
}

async function sendMsg() {
    const inp = document.getElementById('msgIn');
    const text = inp.value.trim();
    if (!text || !myId) return;
    inp.value = '';
    try {
        if (chatType==='group') await post('/api/group-messages', {fromId:myId, groupId:grpId, text});
        else await post('/api/messages', {fromId:myId, toId:targetId, text});
        loadMsgs();
    } catch(e) { toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏','err'); }
}

async function sendPhoto(input) {
    const file = input.files[0];
    if (!file) return;
    if (file.size > 4*1024*1024) { toast('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å 4MB)','err'); return; }
    const reader = new FileReader();
    reader.onload = async e => {
        try {
            if (chatType==='group') await post('/api/group-messages', {fromId:myId, groupId:grpId, text:'', photo:e.target.result});
            else await post('/api/messages', {fromId:myId, toId:targetId, text:'', photo:e.target.result});
            loadMsgs();
        } catch(e2) { toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏','err'); }
    };
    reader.readAsDataURL(file);
    input.value = '';
}

// === GROUPS ===
async function loadGroups() {
    const b = document.getElementById('listBody');
    b.innerHTML = '<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
        const list = await get(`/api/groups/${myId}`);
        if (!list.length) { b.innerHTML = '<div class="empty-hint">–ù–µ—Ç –≥—Ä—É–ø–ø.<br>–í—Å—Ç—É–ø–∏ –ø–æ ID –∏–ª–∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é ‚Üë</div>'; return; }
        b.innerHTML = list.map(g => `
            <div class="chat-item" onclick="openGroup('${g.id}','${esc(g.name)}')">
                <div class="av" style="background:${strColor(g.name)};">üë•</div>
                <div class="ci">
                    <div class="ci-name">${esc(g.name)}</div>
                    <div class="ci-sub">ID: ${g.id} ¬∑ ${g.memberCount} —É—á–∞—Å—Ç–Ω.</div>
                </div>
            </div>`).join('');
    } catch(e) { b.innerHTML = '<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

function openGroup(id, name) {
    stopChat();
    grpId = id; chatType = 'group'; targetId = null;
    document.getElementById('chatName').textContent = name;
    document.getElementById('chatStatus').textContent = `ID: ${id}`;
    const el = document.getElementById('chatAv');
    el.innerHTML = ''; el.textContent = 'üë•'; el.style.background = strColor(name);
    go('s-chat');
    loadMsgs();
    msgInt = setInterval(loadMsgs, 2500);
}

async function joinGrpById() {
    const id = document.getElementById('searchGrp').value.trim().toUpperCase();
    if (!id) return;
    try {
        const r = await post('/api/groups/join', {groupId:id, userId:myId});
        if (r.success) { document.getElementById('searchGrp').value=''; toast('–í—Å—Ç—É–ø–∏–ª –≤ –≥—Ä—É–ø–ø—É!','ok'); loadGroups(); }
        else toast(r.error||'–ù–µ –Ω–∞–π–¥–µ–Ω–∞','err');
    } catch(e) { toast('–û—à–∏–±–∫–∞','err'); }
}

function showCreateGrp() {
    modal('–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É', `
        <input id="mGrpName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..." autocorrect="off">
        <button onclick="createGrp()">–°–û–ó–î–ê–¢–¨</button>`);
}

async function createGrp() {
    const name = document.getElementById('mGrpName').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','err'); return; }
    try {
        const r = await post('/api/groups', {name, creatorId:myId});
        if (r.success) { closeModal(); toast(`–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ${r.groupId}`,'ok'); loadGroups(); }
        else toast(r.error||'–û—à–∏–±–∫–∞','err');
    } catch(e) { toast('–û—à–∏–±–∫–∞','err'); }
}

// === CHANNELS ===
async function loadChannels() {
    const b = document.getElementById('listBody');
    b.innerHTML = '<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    try {
        const list = await get(`/api/channels/${myId}`);
        if (!list.length) { b.innerHTML = '<div class="empty-hint">–ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤.<br>–ü–æ–¥–ø–∏—à–∏—Å—å –ø–æ ID –∏–ª–∏ —Å–æ–∑–¥–∞–π —Å–≤–æ–π ‚Üë</div>'; return; }
        b.innerHTML = list.map(c => `
            <div class="chat-item" onclick="openChan('${c.id}','${esc(c.name)}')">
                <div class="av" style="background:${strColor(c.name)};">üì¢</div>
                <div class="ci">
                    <div class="ci-name">${esc(c.name)}</div>
                    <div class="ci-sub">ID: ${c.id} ¬∑ ${c.subCount} –ø–æ–¥–ø–∏—Å—á.</div>
                </div>
            </div>`).join('');
    } catch(e) { b.innerHTML = '<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

async function subChanById() {
    const id = document.getElementById('searchChan').value.trim().toUpperCase();
    if (!id) return;
    try {
        const r = await post('/api/channels/subscribe', {channelId:id, userId:myId});
        if (r.success) { document.getElementById('searchChan').value=''; toast('–ü–æ–¥–ø–∏—Å–∞–Ω!','ok'); loadChannels(); }
        else toast(r.error||'–ù–µ –Ω–∞–π–¥–µ–Ω','err');
    } catch(e) { toast('–û—à–∏–±–∫–∞','err'); }
}

function showCreateChan() {
    modal('–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª', `
        <input id="mChanName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞..." autocorrect="off">
        <input id="mChanDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." autocorrect="off">
        <button onclick="createChan()">–°–û–ó–î–ê–¢–¨</button>`);
}

async function createChan() {
    const name = document.getElementById('mChanName').value.trim();
    const desc = document.getElementById('mChanDesc').value.trim();
    if (!name) { toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','err'); return; }
    try {
        const r = await post('/api/channels', {name, desc, ownerId:myId});
        if (r.success) { closeModal(); toast(`–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω! ID: ${r.channelId}`,'ok'); loadChannels(); }
        else toast(r.error||'–û—à–∏–±–∫–∞','err');
    } catch(e) { toast('–û—à–∏–±–∫–∞','err'); }
}

async function openChan(id, name) {
    chanId = id;
    document.getElementById('chanTitle').textContent = name;
    try {
        const info = await get(`/api/channels/info/${id}`);
        document.getElementById('postBtn').style.display = info.ownerId===myId ? 'block' : 'none';
    } catch(e) { document.getElementById('postBtn').style.display = 'none'; }
    go('s-channel');
    loadChanPosts();
}

async function loadChanPosts() {
    const b = document.getElementById('chanBody');
    try {
        const posts = await get(`/api/channels/${chanId}/posts?viewerId=${myId}`);
        if (!posts.length) { b.innerHTML = '<div class="empty-hint">–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>'; return; }
        b.innerHTML = [...posts].reverse().map(p => `
            <div class="post-card">
                <div class="post-author">${esc(p.authorName)}</div>
                ${p.photo ? `<img class="post-img" src="${p.photo}" onclick="viewPhoto('${p.photo}')">` : ''}
                ${p.text ? `<div class="post-text">${esc(p.text)}</div>` : ''}
                <div class="post-time">${fmtTime(p.time)} ¬∑ üëÅ ${p.views||0}</div>
            </div>`).join('');
    } catch(e) { b.innerHTML = '<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>'; }
}

function showPostModal() {
    modal('–ù–æ–≤—ã–π –ø–æ—Å—Ç', `
        <textarea id="mPostText" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞..." rows="4" style="resize:none;"></textarea>
        <button onclick="publishPost()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>`);
}

async function publishPost() {
    const text = document.getElementById('mPostText').value.trim();
    if (!text) { toast('–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç','err'); return; }
    try {
        const r = await post(`/api/channels/${chanId}/posts`, {authorId:myId, text});
        if (r.success) { closeModal(); toast('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!','ok'); loadChanPosts(); }
        else toast(r.error||'–û—à–∏–±–∫–∞','err');
    } catch(e) { toast('–û—à–∏–±–∫–∞','err'); }
}

// === PROFILE ===
async function loadMyProfile() {
    if (!myId) return;
    try {
        const p = await get(`/api/profile/${myId}`);
        document.getElementById('myName').textContent = p.username || myUser;
        document.getElementById('myIdLabel').textContent = `ID: ${myId}`;
        document.getElementById('myBio').value = p.bio || '';
        setAvBig('myAv', myId, p.avatar, p.username || myUser);
    } catch(e) {}
}

function setAvBig(elId, id, avatarUrl, name) {
    const el = document.getElementById(elId);
    if (avatarUrl) {
        el.innerHTML = `<img src="${avatarUrl}">`;
        if (id) localStorage.setItem('av_'+id, avatarUrl);
    } else {
        el.innerHTML = ''; el.textContent = (name||'?')[0].toUpperCase(); el.style.background = strColor(name);
    }
}

async function saveBio() {
    const bio = document.getElementById('myBio').value.trim();
    await post('/api/bio', {userId:myId, bio});
    toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','ok');
}

async function changeUsername() {
    const n = document.getElementById('newName').value.trim();
    if (!n) { toast('–í–≤–µ–¥–∏ –Ω–æ–≤–æ–µ –∏–º—è','err'); return; }
    try {
        const r = await post('/api/change-username', {userId:myId, newUsername:n});
        if (r.success) { myUser=r.username; localStorage.setItem('_un',myUser); document.getElementById('myName').textContent=myUser; document.getElementById('newName').value=''; toast('–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ!','ok'); }
        else toast(r.error||'–û—à–∏–±–∫–∞','err');
    } catch(e) { toast('–û—à–∏–±–∫–∞','err'); }
}

function pickAvatar() {
    const inp = document.createElement('input');
    inp.type='file'; inp.accept='image/*';
    inp.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;
        if (file.size > 2*1024*1024) { toast('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å 2MB)','err'); return; }
        const reader = new FileReader();
        reader.onload = async ev => {
            await post('/api/avatar', {userId:myId, avatar:ev.target.result});
            localStorage.setItem('av_'+myId, ev.target.result);
            loadMyProfile();
            toast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!','ok');
        };
        reader.readAsDataURL(file);
    };
    inp.click();
}

// === USER PROFILE VIEW ===
function openViewedProfile() {
    if (!targetId || chatType!=='direct') return;
    viewProfile(targetId, targetName);
}

function viewProfile(id, name) {
    upId = id; upName = name;
    get(`/api/profile/${id}`).then(p => {
        document.getElementById('upName').textContent = p.username || name || id;
        document.getElementById('upBio').textContent = p.bio || '';
        setAvBig('upAv', id, p.avatar, p.username || name);
        go('s-uprofile');
    }).catch(() => toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è','err'));
}

function msgViewedUser() {
    if (!upId) return;
    goBack();
    openChat(upId, upName || upId);
}

// === LOGOUT ===
function logout() {
    stopChat();
    myId=null; myUser=null;
    localStorage.removeItem('_id'); localStorage.removeItem('_un');
    hist=[];
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    document.getElementById('s-auth').classList.add('active');
    document.getElementById('aName').value='';
    document.getElementById('aPass').value='';
    document.getElementById('aMsg').textContent='';
}

// === MODAL ===
function modal(title, content) {
    closeModal();
    const ov = document.createElement('div');
    ov.className='modal-ov'; ov.id='mOv';
    ov.innerHTML = `<div class="modal-box">
        <div class="modal-head"><div class="modal-title">${title}</div><button class="ghost" onclick="closeModal()" style="font-size:1.1rem;">‚úï</button></div>
        ${content}</div>`;
    ov.addEventListener('click', e => { if(e.target===ov) closeModal(); });
    document.getElementById('app').appendChild(ov);
}
function closeModal() { const m=document.getElementById('mOv'); if(m) m.remove(); }

// === PHOTO VIEWER ===
function viewPhoto(src) {
    const ov=document.createElement('div');
    ov.className='photo-ov';
    ov.innerHTML=`<img src="${src}">`;
    ov.onclick=()=>ov.remove();
    document.getElementById('app').appendChild(ov);
}

// === UTILS ===
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function strColor(s) {
    const cols=['#ff6600','#7c6bff','#00aa44','#e040fb','#0099cc','#ff4466','#00ccaa'];
    let h=0; for(let i=0;i<(s||'').length;i++) h=(h*31+s.charCodeAt(i))&0xffff;
    return cols[h%cols.length];
}
function avHtml(name, url, sz) {
    const s=`width:${sz}px;height:${sz}px;`;
    if(url) return `<div class="av" style="${s}"><img src="${url}"></div>`;
    return `<div class="av" style="${s}background:${strColor(name)};">${(name||'?')[0].toUpperCase()}</div>`;
}
function fmtTime(ts) {
    const d=new Date(ts), n=new Date();
    const hh=String(d.getHours()).padStart(2,'0'), mm=String(d.getMinutes()).padStart(2,'0');
    return d.toDateString()===n.toDateString() ? `${hh}:${mm}` : `${d.getDate()}.${d.getMonth()+1} ${hh}:${mm}`;
}
function ago(ts) {
    const s=Math.floor((Date.now()-ts)/1000);
    if(s<60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if(s<3600) return `${Math.floor(s/60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
    if(s<86400) return `${Math.floor(s/3600)} —á. –Ω–∞–∑–∞–¥`;
    return `${Math.floor(s/86400)} –¥–Ω. –Ω–∞–∑–∞–¥`;
}

// === INIT ===
renderThemes();
const _id=localStorage.getItem('_id'), _un=localStorage.getItem('_un');
if(_id && _un) { myId=_id; myUser=_un; onLogin(); }
</script>
</body>
</html>
