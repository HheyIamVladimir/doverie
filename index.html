<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#ff6600">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="–î–æ–≤–µ—Ä–∏–µ">
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icon-192.svg">
<title>–î–æ–≤–µ—Ä–∏–µ</title>
<style>
/* === THEMES === */
:root {
    --bg:#0f0f0f; --surface:#1a1a1a; --surface2:#242424;
    --accent:#ff6600; --accent2:#ff8833;
    --text:#f0f0f0; --text-muted:#777; --border:#2a2a2a;
    --msg-my-bg:#ff6600; --msg-my-color:#fff;
    --msg-their-bg:#242424; --msg-their-color:#f0f0f0;
    --header-bg:#141414; --radius:14px;
}
[data-theme="light"] {
    --bg:#f2f2f2; --surface:#fff; --surface2:#ebebeb;
    --accent:#ff6600; --accent2:#ff8833;
    --text:#111; --text-muted:#888; --border:#ddd;
    --msg-my-bg:#ff6600; --msg-my-color:#fff;
    --msg-their-bg:#e4e4e4; --msg-their-color:#111;
    --header-bg:#fff;
}
[data-theme="neon"] {
    --bg:#05050f; --surface:#0c0c20; --surface2:#131330;
    --accent:#00ffcc; --accent2:#ff00ff;
    --text:#e0ffe0; --text-muted:#3a5a3a; --border:#1a1a40;
    --msg-my-bg:#00ffcc; --msg-my-color:#000;
    --msg-their-bg:#131330; --msg-their-color:#e0ffe0;
    --header-bg:#080818;
}
[data-theme="ocean"] {
    --bg:#060e18; --surface:#0d1e30; --surface2:#122840;
    --accent:#0099ff; --accent2:#00ccff;
    --text:#d0eeff; --text-muted:#3a6080; --border:#0d2540;
    --msg-my-bg:#0099ff; --msg-my-color:#fff;
    --msg-their-bg:#122840; --msg-their-color:#d0eeff;
    --header-bg:#081422;
}
[data-theme="matrix"] {
    --bg:#000; --surface:#0a0a0a; --surface2:#111;
    --accent:#00ff41; --accent2:#00cc33;
    --text:#00ff41; --text-muted:#004d15; --border:#001a00;
    --msg-my-bg:#003300; --msg-my-color:#00ff41;
    --msg-their-bg:#0a0a0a; --msg-their-color:#00ff41;
    --header-bg:#050505;
}

/* === BASE === */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{background:var(--bg);color:var(--text);font-family:'Courier New',monospace;height:100dvh;overflow:hidden;display:flex;justify-content:center;}
.app{width:100%;max-width:600px;height:100dvh;display:flex;flex-direction:column;background:var(--surface);position:relative;overflow:hidden;}

/* === SCREENS === */
.screen{display:none;flex-direction:column;flex:1;overflow:hidden;}
.screen.active{display:flex;animation:scIn .22s ease both;}
@keyframes scIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}

/* === HEADER === */
.hdr{background:var(--header-bg);border-bottom:1px solid var(--border);padding:10px 12px;display:flex;align-items:center;gap:8px;min-height:54px;flex-shrink:0;}
.hdr-title{font-size:.95rem;font-weight:bold;letter-spacing:.08em;flex:1;}

/* === BUTTONS === */
button{cursor:pointer;background:var(--accent);color:#fff;border:none;border-radius:10px;font-family:inherit;font-size:.88rem;font-weight:bold;letter-spacing:.05em;padding:11px 16px;transition:opacity .15s,transform .1s;}
button:active{transform:scale(.96);opacity:.82;}
button.sec{background:var(--surface2);color:var(--text);}
button.ghost{background:none;color:var(--text-muted);padding:7px 10px;}
button.danger{background:#e53935;color:#fff;}

/* === INPUTS === */
input,textarea{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:inherit;font-size:.93rem;padding:11px 13px;outline:none;transition:border-color .2s;}
input:focus,textarea:focus{border-color:var(--accent);}

/* === AUTH === */
#s-auth{align-items:center;justify-content:center;padding:20px;background:var(--bg);}
.auth-box{width:100%;max-width:360px;display:flex;flex-direction:column;gap:13px;animation:authIn .4s ease both;}
@keyframes authIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.auth-logo{text-align:center;margin-bottom:4px;}
.auth-logo-img{width:90px;height:90px;border-radius:20px;object-fit:cover;display:block;margin:0 auto 10px;}
.auth-logo-text{font-size:2rem;font-weight:bold;letter-spacing:.15em;color:var(--accent);}
.auth-logo-sub{font-size:.68rem;color:var(--text-muted);letter-spacing:.2em;margin-top:3px;}
.auth-tabs{display:flex;background:var(--surface2);border-radius:10px;overflow:hidden;}
.auth-tab{flex:1;background:none;color:var(--text-muted);border-radius:0;font-size:.82rem;padding:10px;}
.auth-tab.active{background:var(--accent);color:#fff;}
.auth-msg{font-size:.8rem;color:#e53935;text-align:center;min-height:16px;}

/* === BOTTOM NAV === */
.bnav{display:flex;background:var(--header-bg);border-top:1px solid var(--border);flex-shrink:0;}
.bnav-btn{flex:1;background:none;color:var(--text-muted);border-radius:0;padding:9px 4px;font-size:.62rem;letter-spacing:.05em;display:flex;flex-direction:column;align-items:center;gap:3px;transition:color .15s;}
.bnav-btn .ico{font-size:1.3rem;transition:transform .2s;}
.bnav-btn.active{color:var(--accent);}
.bnav-btn.active .ico{transform:scale(1.15);}

/* === MAIN TABS === */
.tabs{display:flex;background:var(--header-bg);border-bottom:1px solid var(--border);flex-shrink:0;}
.tab{flex:1;background:none;color:var(--text-muted);border-radius:0;font-size:.75rem;padding:11px 4px;letter-spacing:.07em;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* === SEARCH ROW === */
.srow{padding:9px 11px;background:var(--header-bg);border-bottom:1px solid var(--border);display:flex;gap:7px;flex-shrink:0;align-items:flex-start;}
.srow input{margin:0;}
.srow button{width:auto;padding:10px 13px;flex-shrink:0;}
.scol{flex-direction:column;gap:8px;}
.scol-r{display:flex;gap:7px;width:100%;}
.scol-r input{margin:0;flex:1;}
.scol-r button{flex-shrink:0;width:auto;padding:10px 13px;}

/* === LIST === */
.list-body{flex:1;overflow-y:auto;}
.chat-item{display:flex;align-items:center;gap:11px;padding:11px 13px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .12s;animation:itemIn .2s ease both;}
@keyframes itemIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:none}}
.chat-item:active{background:var(--surface2);}
.av{width:44px;height:44px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:bold;color:#fff;flex-shrink:0;overflow:hidden;}
.av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ci{flex:1;min-width:0;}
.ci-name{font-size:.92rem;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ci-sub{font-size:.76rem;color:var(--text-muted);margin-top:2px;}
.ubadge{background:var(--accent);color:#fff;border-radius:20px;font-size:.7rem;font-weight:bold;padding:2px 7px;flex-shrink:0;animation:popIn .2s ease;}
@keyframes popIn{from{transform:scale(0)}to{transform:scale(1)}}
.empty-hint{text-align:center;color:var(--text-muted);padding:50px 20px;font-size:.83rem;line-height:2;}

/* === CHAT === */
.chat-hav{width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.95rem;font-weight:bold;color:#fff;flex-shrink:0;overflow:hidden;cursor:pointer;}
.chat-hav img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.chat-hinfo{flex:1;min-width:0;}
.chat-hname{font-size:.92rem;font-weight:bold;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chat-hstatus{font-size:.73rem;color:var(--text-muted);}
.chat-hstatus.online{color:#4caf50;}

.chat-history{flex:1;overflow-y:auto;padding:11px;display:flex;flex-direction:column;gap:5px;background:var(--bg);}
.mw{display:flex;flex-direction:column;animation:msgIn .18s ease both;}
@keyframes msgIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.mw.my{align-items:flex-end;}
.mw.their{align-items:flex-start;}
.ms{font-size:.7rem;color:var(--accent2);margin-bottom:2px;padding:0 3px;}
.mb{max-width:78%;padding:8px 12px;border-radius:13px;font-size:.91rem;line-height:1.45;word-break:break-word;}
.mw.my .mb{background:var(--msg-my-bg);color:var(--msg-my-color);border-bottom-right-radius:3px;}
.mw.their .mb{background:var(--msg-their-bg);color:var(--msg-their-color);border-bottom-left-radius:3px;}
.mt{font-size:.67rem;opacity:.55;margin-top:3px;text-align:right;}
.msg-photo{max-width:200px;border-radius:9px;display:block;margin-bottom:3px;cursor:pointer;}

.input-area{padding:9px 11px;background:var(--header-bg);border-top:1px solid var(--border);display:flex;gap:7px;align-items:center;flex-shrink:0;}
.input-area input{margin:0;flex:1;padding:10px 13px;}
.input-area button{width:auto;padding:10px 13px;flex-shrink:0;}

/* === FEED === */
.feed-body{flex:1;overflow-y:auto;padding:12px;background:var(--bg);}
.post-card{background:var(--surface);border-radius:14px;padding:14px;margin-bottom:10px;animation:cardIn .25s ease both;border:1px solid var(--border);}
@keyframes cardIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
.post-head{display:flex;align-items:center;gap:9px;margin-bottom:10px;}
.post-av{width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.9rem;font-weight:bold;color:#fff;flex-shrink:0;overflow:hidden;}
.post-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.post-author{font-size:.88rem;font-weight:bold;}
.post-time-small{font-size:.72rem;color:var(--text-muted);}
.post-title{font-size:.95rem;font-weight:bold;margin-bottom:6px;}
.post-text{font-size:.9rem;line-height:1.55;color:var(--text);}
.post-img{width:100%;border-radius:10px;margin:9px 0;display:block;cursor:pointer;}
.post-meta{font-size:.72rem;color:var(--text-muted);margin-top:8px;}
.compose-bar{padding:10px 12px;background:var(--header-bg);border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-shrink:0;}
.compose-btn{flex:1;background:var(--surface2);color:var(--text-muted);text-align:left;font-weight:normal;border-radius:20px;padding:10px 15px;font-size:.88rem;}

/* === PROFILE === */
.prof-body{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:14px;background:var(--bg);}
.prof-av{width:80px;height:80px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:2.2rem;font-weight:bold;color:#fff;margin:0 auto;overflow:hidden;cursor:pointer;transition:transform .2s;}
.prof-av:active{transform:scale(.93);}
.prof-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.prof-name{text-align:center;font-size:1.05rem;font-weight:bold;}
.prof-bio{text-align:center;color:var(--text-muted);font-size:.83rem;}
.sec-title{font-size:.73rem;color:var(--text-muted);letter-spacing:.1em;}

/* === THEMES === */
.theme-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:7px;}
.theme-btn{aspect-ratio:1;border-radius:11px;border:2px solid transparent;cursor:pointer;font-size:.6rem;font-weight:bold;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;padding:5px 3px;letter-spacing:0;background:none;color:inherit;transition:border-color .2s,transform .15s;}
.theme-btn:active{transform:scale(.92);}
.theme-btn.sel{border-color:var(--accent)!important;}

/* === RULES === */
.rules-body{flex:1;overflow-y:auto;padding:16px;background:var(--bg);display:flex;flex-direction:column;gap:12px;}
.rule-card{background:var(--surface);border-radius:12px;padding:14px;border-left:3px solid var(--accent);animation:cardIn .25s ease both;}
.rule-num{font-size:.72rem;color:var(--accent);font-weight:bold;letter-spacing:.1em;margin-bottom:4px;}
.rule-title{font-size:.92rem;font-weight:bold;margin-bottom:5px;}
.rule-text{font-size:.82rem;color:var(--text-muted);line-height:1.6;}

/* === SETTINGS === */
.settings-item{background:var(--surface);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:background .15s;border:1px solid var(--border);}
.settings-item:active{background:var(--surface2);}
.settings-icon{font-size:1.4rem;flex-shrink:0;}
.settings-info{flex:1;}
.settings-title{font-size:.9rem;font-weight:bold;}
.settings-sub{font-size:.77rem;color:var(--text-muted);margin-top:2px;}

/* === CHANNEL VIEW === */
.chan-post-card{background:var(--surface);border-radius:14px;padding:14px;margin-bottom:10px;border:1px solid var(--border);animation:cardIn .25s ease both;}

/* === TOAST === */
.toast{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:20px;padding:9px 20px;font-size:.83rem;z-index:9999;white-space:nowrap;max-width:88vw;pointer-events:none;animation:toastIn .2s ease;}
@keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(8px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.toast.ok{border-color:#4caf50;color:#4caf50;}
.toast.err{border-color:#e53935;color:#e53935;}

/* === MODAL === */
.modal-ov{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:2000;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal-box{background:var(--surface);border-radius:18px 18px 0 0;padding:18px;width:100%;max-width:600px;display:flex;flex-direction:column;gap:11px;max-height:80dvh;overflow-y:auto;animation:slideUp .22s ease;}
@keyframes slideUp{from{transform:translateY(30px)}to{transform:none}}
.modal-head{display:flex;align-items:center;justify-content:space-between;}
.modal-title{font-size:.95rem;font-weight:bold;}

/* === PHOTO OV === */
.photo-ov{position:fixed;inset:0;background:rgba(0,0,0,.96);z-index:5000;display:flex;align-items:center;justify-content:center;animation:fadeIn .15s ease;}
.photo-ov img{max-width:95vw;max-height:90dvh;border-radius:9px;}

/* === SHIELD MODAL === */
.shield-pass{background:var(--surface2);border-radius:10px;padding:14px;font-size:1.1rem;font-weight:bold;letter-spacing:.08em;text-align:center;word-break:break-all;color:var(--accent);border:1px dashed var(--accent);}


/* === ONLINE PULSE === */
.online-pulse {
    width:10px;height:10px;border-radius:50%;background:#4caf50;
    flex-shrink:0;position:relative;
}
.online-pulse::after {
    content:'';position:absolute;inset:-3px;border-radius:50%;
    border:2px solid #4caf50;animation:pulse 1.5s ease-out infinite;opacity:0;
}
@keyframes pulse{0%{transform:scale(1);opacity:.8}100%{transform:scale(2.2);opacity:0}}

/* === TYPING === */
.typing-dots {
    display:inline-flex;gap:3px;align-items:center;
}
.typing-dots span {
    width:5px;height:5px;border-radius:50%;background:var(--text-muted);
    animation:tdot .9s ease-in-out infinite;
}
.typing-dots span:nth-child(2){animation-delay:.15s;}
.typing-dots span:nth-child(3){animation-delay:.3s;}
@keyframes tdot{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-5px)}}

/* === REACTIONS === */
.reactions-row {
    display:flex;flex-wrap:wrap;gap:4px;margin-top:5px;
}
.reaction-chip {
    background:var(--surface2);border:1px solid var(--border);
    border-radius:20px;padding:3px 8px;font-size:.82rem;
    cursor:pointer;transition:transform .15s,background .15s;
    display:flex;align-items:center;gap:3px;
}
.reaction-chip:active{transform:scale(.9);}
.reaction-chip.mine{background:var(--accent);border-color:var(--accent);color:#fff;}
.reaction-picker {
    position:fixed;z-index:3000;
    background:var(--surface);border:1px solid var(--border);
    border-radius:14px;padding:8px 10px;
    display:flex;gap:6px;box-shadow:0 4px 20px rgba(0,0,0,.4);
    animation:popIn .15s ease;
}
.reaction-picker button {
    background:none;border:none;font-size:1.4rem;padding:4px;
    border-radius:8px;transition:transform .15s,background .15s;
}
.reaction-picker button:active{transform:scale(.85);background:var(--surface2);}

/* === REPLY PREVIEW === */
.reply-preview {
    background:var(--surface2);border-left:3px solid var(--accent);
    border-radius:8px;padding:7px 10px;margin-bottom:7px;
    display:flex;align-items:center;gap:8px;
    animation:scIn .15s ease;
}
.reply-preview-text{flex:1;font-size:.8rem;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.reply-quote {
    background:rgba(255,255,255,.06);border-left:3px solid var(--accent2);
    border-radius:6px;padding:5px 9px;margin-bottom:5px;font-size:.8rem;
    color:var(--text-muted);
}

/* === ADMIN === */
.admin-card {
    background:var(--surface);border-radius:12px;padding:13px;
    border:1px solid var(--border);margin-bottom:9px;
    display:flex;align-items:center;gap:11px;
    animation:cardIn .2s ease both;
}
.admin-badge {
    background:#e53935;color:#fff;border-radius:6px;
    font-size:.7rem;padding:2px 7px;font-weight:bold;
}
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px;}
/* ‚îÄ‚îÄ OFFLINE / PWA ‚îÄ‚îÄ */
#offline-bar{display:none;position:fixed;top:0;left:0;right:0;z-index:9999;
  background:#c0392b;color:#fff;text-align:center;font-size:.78rem;font-weight:700;
  padding:7px 12px;letter-spacing:.04em;animation:slideDown .3s ease;}
#offline-bar.show{display:block;}
@keyframes slideDown{from{transform:translateY(-100%)}to{transform:translateY(0)}}
.msg-queued{opacity:.55;}
.msg-queued .mt::after{content:' ‚è≥';font-size:.7rem;}
</style>
</head>
<body>
<div id="offline-bar">üìµ –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—ç—à. –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–µ—Ç–∏.</div>
<div class="app" id="app">

<!-- AUTH -->
<div id="s-auth" class="screen active">
  <div class="auth-box">
    <div class="auth-logo">
      <img class="auth-logo-img" src="filler.png" onerror="this.style.display='none'">
      <div class="auth-logo-text">–î–û–í–ï–†–ò–ï</div>
      <div class="auth-logo-sub">–ú–ï–°–°–ï–ù–î–ñ–ï–†</div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="atab-login" onclick="setAuthMode('login')">–í–•–û–î</button>
      <button class="auth-tab" id="atab-reg" onclick="setAuthMode('reg')">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
    <input id="aName" type="text" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º" autocomplete="off" autocorrect="off" autocapitalize="off" onkeydown="if(event.key==='Enter')doAuth()">
    <input id="aPass" type="password" placeholder="–ü–∞—Ä–æ–ª—å" onkeydown="if(event.key==='Enter')doAuth()">
    <div id="aMsg" class="auth-msg"></div>
    <button id="aBtn" onclick="doAuth()">–í–û–ô–¢–ò</button>
  </div>
</div>

<!-- MAIN -->
<div id="s-main" class="screen">
  <div class="hdr">
    <div class="hdr-title" id="mainTitle">–ß–ê–¢–´</div>
    <button class="ghost" onclick="go('s-settings')" style="font-size:1.15rem;">‚öôÔ∏è</button>
  </div>
  <div class="tabs">
    <button class="tab active" id="tab-chats" onclick="switchTab('chats')">üí¨ –ß–ê–¢–´</button>
    <button class="tab" id="tab-groups" onclick="switchTab('groups')">üë• –ì–†–£–ü–ü–´</button>
    <button class="tab" id="tab-channels" onclick="switchTab('channels')">üì¢ –ö–ê–ù–ê–õ–´</button>
  </div>
  <div id="sr-chats" class="srow">
    <input id="searchUser" placeholder="–ü–æ–∏—Å–∫ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É..." autocorrect="off" autocapitalize="off" onkeydown="if(event.key==='Enter')findUser()">
    <button onclick="findUser()">üîç</button>
  </div>
  <div id="sr-groups" class="srow scol" style="display:none;">
    <div class="scol-r">
      <input id="searchGrp" placeholder="ID –≥—Ä—É–ø–ø—ã (G-0001)..." autocorrect="off" autocapitalize="off">
      <button onclick="joinGrpById()">‚ûï</button>
    </div>
    <button class="sec" style="width:100%;" onclick="showCreateGrp()">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
  </div>
  <div id="sr-channels" class="srow scol" style="display:none;">
    <div class="scol-r">
      <input id="searchChan" placeholder="ID –∫–∞–Ω–∞–ª–∞ (D-0001)..." autocorrect="off" autocapitalize="off">
      <button onclick="subChanById()">‚ûï</button>
    </div>
    <button class="sec" style="width:100%;" onclick="showCreateChan()">+ –°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª</button>
  </div>
  <div class="list-body" id="listBody"></div>
  <div class="bnav">
    <button class="bnav-btn" id="bn-chats" onclick="goMain()"><span class="ico">üí¨</span>–ß–ê–¢–´</button>
    <button class="bnav-btn" id="bn-calls" onclick="goCalls()"><span class="ico">üìû</span>–ó–í–û–ù–ö–ò</button>
    <button class="bnav-btn" id="bn-feed" onclick="goFeed()"><span class="ico">üìÉ</span>–õ–ï–ù–¢–ê</button>
    <button class="bnav-btn" id="bn-profile" onclick="goProfile()"><span class="ico">üë§</span>–ü–†–û–§–ò–õ–¨</button>
    <button class="bnav-btn" id="bn-rules" onclick="goRules()"><span class="ico">üìñ</span>–ü–†–ê–í–ò–õ–ê</button>
  </div>
</div>

<!-- CHAT -->
<div id="s-chat" class="screen">
  <div class="hdr">
    <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
    <div class="chat-hav" id="chatAv" onclick="openViewedProfile()">?</div>
    <div class="chat-hinfo">
      <div class="chat-hname" id="chatName">–ß–ê–¢</div>
      <div class="chat-hstatus" id="chatStatus"></div>
    </div>
    <button class="ghost" onclick="startJitsiCall()" style="font-size:1.2rem;" title="–ü–æ–∑–≤–æ–Ω–∏—Ç—å">üìû</button>
  </div>
  <div class="chat-history" id="chatHist"></div>
  <div class="input-area">
    <input type="file" id="photoInput" accept="image/*" style="display:none" onchange="sendPhoto(this)">
    <button class="ghost" onclick="document.getElementById('photoInput').click()" style="font-size:1.1rem;">üìé</button>
    <input id="msgIn" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter')sendMsg()" oninput="onTyping()">
    <button onclick="sendMsg()">‚û§</button>
  </div>
</div>

<!-- CHANNEL VIEW -->
<div id="s-channel" class="screen">
  <div class="hdr">
    <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
    <div class="hdr-title" id="chanTitle">–ö–ê–ù–ê–õ</div>
    <button class="ghost" id="postBtn" style="display:none;" onclick="showPostModal()">‚úèÔ∏è</button>
  </div>
  <div class="list-body" id="chanBody" style="padding:11px;"></div>
</div>

<!-- FEED -->
<div id="s-feed" class="screen">
  <div class="hdr">
    <div class="hdr-title">üìÉ –õ–ï–ù–¢–ê</div>
  </div>
  <div class="feed-body" id="feedBody"></div>
  <div style="padding:9px 11px;background:var(--header-bg);border-top:1px solid var(--border);display:flex;gap:8px;align-items:center;flex-shrink:0;">
    <button style="flex:1;background:var(--surface2);color:var(--text-muted);text-align:left;font-weight:normal;border-radius:20px;padding:10px 15px;font-size:.88rem;" onclick="showComposeModal()">‚úèÔ∏è –ß—Ç–æ –Ω–æ–≤–æ–≥–æ?</button>
    <button onclick="showComposeModal()" style="padding:10px 13px;width:auto;">üì∑</button>
  </div>
  <div class="bnav">
    <button class="bnav-btn" id="bn-chats2" onclick="goMain()"><span class="ico">üí¨</span>–ß–ê–¢–´</button>
    <button class="bnav-btn" id="bn-calls2" onclick="goCalls()"><span class="ico">üìû</span>–ó–í–û–ù–ö–ò</button>
    <button class="bnav-btn" id="bn-feed2" onclick="goFeed()"><span class="ico">üìÉ</span>–õ–ï–ù–¢–ê</button>
    <button class="bnav-btn" id="bn-profile2" onclick="goProfile()"><span class="ico">üë§</span>–ü–†–û–§–ò–õ–¨</button>
    <button class="bnav-btn" id="bn-rules2" onclick="goRules()"><span class="ico">üìñ</span>–ü–†–ê–í–ò–õ–ê</button>
  </div>

</div>

<!-- RULES -->
<div id="s-rules" class="screen">
  <div class="hdr">
    <div class="hdr-title">üìñ –ü–†–ê–í–ò–õ–ê</div>
  </div>
  <div class="rules-body" id="rulesBody"></div>
  <div class="bnav">
    <button class="bnav-btn" id="bn-chats3" onclick="goMain()"><span class="ico">üí¨</span>–ß–ê–¢–´</button>
    <button class="bnav-btn" id="bn-calls3" onclick="goCalls()"><span class="ico">üìû</span>–ó–í–û–ù–ö–ò</button>
    <button class="bnav-btn" id="bn-feed3" onclick="goFeed()"><span class="ico">üìÉ</span>–õ–ï–ù–¢–ê</button>
    <button class="bnav-btn" id="bn-profile3" onclick="goProfile()"><span class="ico">üë§</span>–ü–†–û–§–ò–õ–¨</button>
    <button class="bnav-btn" id="bn-rules3" onclick="goRules()"><span class="ico">üìñ</span>–ü–†–ê–í–ò–õ–ê</button>
  </div>
</div>

<!-- CALL SCREEN -->
<div id="s-call" class="screen" style="background:#000;">
  <div class="hdr" style="background:#111;border-bottom:1px solid #333;">
    <div style="color:#fff;font-weight:bold;font-size:.95rem;" id="callWithName">–ó–≤–æ–Ω–æ–∫</div>
    <button onclick="endJitsiCall()" style="background:#e53935;color:#fff;border:none;border-radius:8px;padding:8px 16px;font-weight:bold;cursor:pointer;font-size:.85rem;">üìµ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
  </div>
  <iframe id="jitsiFrame" style="flex:1;border:none;width:100%;" allow="camera; microphone; fullscreen; display-capture"></iframe>
</div>

<!-- CALL HISTORY -->
<div id="s-calls" class="screen">
  <div class="hdr">
    <div class="hdr-title">üìû –ó–í–û–ù–ö–ò</div>
  </div>
  <div class="list-body" id="callHistBody" style="padding:8px;"></div>
  <div class="bnav">
    <button class="bnav-btn" id="bn-chats4" onclick="goMain()"><span class="ico">üí¨</span>–ß–ê–¢–´</button>
    <button class="bnav-btn" id="bn-calls4" onclick="goCalls()"><span class="ico">üìû</span>–ó–í–û–ù–ö–ò</button>
    <button class="bnav-btn" id="bn-feed4" onclick="goFeed()"><span class="ico">üìÉ</span>–õ–ï–ù–¢–ê</button>
    <button class="bnav-btn" id="bn-profile4" onclick="goProfile()"><span class="ico">üë§</span>–ü–†–û–§–ò–õ–¨</button>
    <button class="bnav-btn" id="bn-rules4" onclick="goRules()"><span class="ico">üìñ</span>–ü–†–ê–í–ò–õ–ê</button>
  </div>
</div>

<!-- MY PROFILE -->
<div id="s-profile" class="screen">
  <div class="hdr">
    <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
    <div class="hdr-title">–ú–û–ô –ü–†–û–§–ò–õ–¨</div>
    <button class="danger" onclick="logout()" style="font-size:.75rem;padding:7px 11px;">–í–´–ô–¢–ò</button>
  </div>
  <div class="prof-body">
    <div class="prof-av" id="myAv" onclick="pickAvatar()">?</div>
    <div class="prof-name" id="myName"></div>
    <div style="text-align:center;font-size:.75rem;color:var(--text-muted);" id="myIdLabel"></div>
    <div style="display:flex;flex-direction:column;gap:7px;">
      <div class="sec-title">–ë–ò–û</div>
      <textarea id="myBio" placeholder="–û —Å–µ–±–µ..." rows="3" style="resize:none;"></textarea>
      <button onclick="saveBio()">–°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
    <div style="display:flex;flex-direction:column;gap:7px;">
      <div class="sec-title">–°–ú–ï–ù–ò–¢–¨ –ò–ú–Ø</div>
      <input id="newName" placeholder="–ù–æ–≤—ã–π —é–∑–µ—Ä–Ω–µ–π–º..." autocorrect="off" autocapitalize="off">
      <button onclick="changeUsername()">–°–ú–ï–ù–ò–¢–¨</button>
    </div>
  </div>
</div>

<!-- SETTINGS -->
<div id="s-settings" class="screen">
  <div class="hdr">
    <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
    <div class="hdr-title">–ù–ê–°–¢–†–û–ô–ö–ò</div>
  </div>
  <div class="prof-body">
    <div class="sec-title">–¢–ï–ú–ê –û–§–û–†–ú–õ–ï–ù–ò–Ø</div>
    <div class="theme-grid" id="themeGrid"></div>
    <div style="height:8px;"></div>
    <div class="settings-item" onclick="showShield()">
      <div class="settings-icon">üõ°</div>
      <div class="settings-info">
        <div class="settings-title">üõ° –ó–ê–©–ò–¢–ò –ú–ï–ù–Ø! üõ°</div>
        <div class="settings-sub">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞</div>
      </div>
      <div style="color:var(--text-muted);font-size:1rem;">‚Ä∫</div>
    </div>
    <div class="settings-item" onclick="go('s-profile')">
      <div class="settings-icon">üë§</div>
      <div class="settings-info">
        <div class="settings-title">–ú–û–ô –ü–†–û–§–ò–õ–¨</div>
        <div class="settings-sub">–ê–≤–∞—Ç–∞—Ä, –∏–º—è, –±–∏–æ–≥—Ä–∞—Ñ–∏—è</div>
      </div>
      <div style="color:var(--text-muted);font-size:1rem;">‚Ä∫</div>
    </div>
  </div>
</div>

<!-- USER PROFILE VIEW -->
<div id="s-uprofile" class="screen">
  <div class="hdr">
    <button class="ghost" onclick="goBack()" style="font-size:1.2rem;">‚Üê</button>
    <div class="hdr-title">–ü–†–û–§–ò–õ–¨</div>
  </div>
  <div class="prof-body">
    <div class="prof-av" id="upAv" style="cursor:default;">?</div>
    <div class="prof-name" id="upName"></div>
    <div class="prof-bio" id="upBio"></div>
    <button onclick="msgViewedUser()">üí¨ –ù–ê–ü–ò–°–ê–¢–¨</button>
  </div>
</div>

<!-- ADMIN -->
<div id="s-admin" class="screen">
  <div class="hdr">
    <button class="ghost" onclick="logout()" style="font-size:1.2rem;">‚Üê</button>
    <div class="hdr-title">üõ° –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–¨</div>
  </div>
  <div class="prof-body">
    <div class="sec-title">–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò</div>
    <div id="adminList"></div>
  </div>
</div>

</div>

<script>
let myId=null,myUser=null,tab='chats',targetId=null,targetName=null;
let chatType='direct',grpId=null,chanId=null;
let msgInt=null,statInt=null,authMode='login';
let hist=[],upId=null,upName=null;

const THEMES=[
  {id:'dark',  name:'–¢–Å–ú–ù–ê–Ø', bg:'#0f0f0f',ac:'#ff6600'},
  {id:'light', name:'–°–í–ï–¢–õ–ê–Ø',bg:'#f5f5f5',ac:'#ff6600'},
  {id:'neon',  name:'–ù–ï–û–ù',   bg:'#05050f',ac:'#00ffcc'},
  {id:'ocean', name:'–û–ö–ï–ê–ù',  bg:'#060e18',ac:'#0099ff'},
  {id:'matrix',name:'–ú–ê–¢–†–ò–¶–ê',bg:'#000',   ac:'#00ff41'},
];

const RULES=[
  {title:'–£–≤–∞–∂–∞–π –¥—Ä—É–≥–∏—Ö',text:'–û–±—â–∞–π—Å—è –≤–µ–∂–ª–∏–≤–æ. –û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è, —É–Ω–∏–∂–µ–Ω–∏—è –∏ –∞–≥—Ä–µ—Å—Å–∏—è –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã ‚Äî –Ω–µ–≤–∞–∂–Ω–æ –Ω–∞—Å–∫–æ–ª—å–∫–æ —Ç—ã –∑–æ–ª.'},
  {title:'–ù–∏–∫–∞–∫–æ–≥–æ —Å–ø–∞–º–∞',text:'–ù–µ —Ä–∞—Å—Å—ã–ª–∞–π –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ä–∞–∑–Ω—ã–µ —á–∞—Ç—ã. –†–µ–∫–ª–∞–º—É –±–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è –Ω–µ —Ä–∞–∑–º–µ—â–∞–π.'},
  {title:'–ó–∞—â–∏—Ç–∞ –ª–∏—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö',text:'–ù–µ –ø—É–±–ª–∏–∫—É–π –ª–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –∏—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è: –∞–¥—Ä–µ—Å–∞, —Ñ–æ—Ç–æ, –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤.'},
  {title:'–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç',text:'–ú–∞—Ç–µ—Ä–∏–∞–ª—ã, –ø—Ä–æ–ø–∞–≥–∞–Ω–¥–∏—Ä—É—é—â–∏–µ –Ω–∞—Å–∏–ª–∏–µ, –Ω–µ–Ω–∞–≤–∏—Å—Ç—å –∏–ª–∏ –Ω–∞—Ä—É—à–∞—é—â–∏–µ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ ‚Äî –ø–æ–¥ —Å—Ç—Ä–æ–≥–∏–º –∑–∞–ø—Ä–µ—Ç–æ–º.'},
  {title:'–ß–µ—Å—Ç–Ω–æ—Å—Ç—å',text:'–ù–µ –≤—ã–¥–∞–≤–∞–π —Å–µ–±—è –∑–∞ –¥—Ä—É–≥–∏—Ö. –§–µ–π–∫–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ –≤–µ–¥—É—Ç –∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ.'},
  {title:'–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç–∞',text:'–ò—Å–ø–æ–ª—å–∑—É–π –Ω–∞–¥—ë–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ù–∏–∫–æ–º—É –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞. –§—É–Ω–∫—Ü–∏—è ¬´–ó–∞—â–∏—Ç–∏ –º–µ–Ω—è¬ª –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å.'},
  {title:'–ö–æ–Ω—Ç–µ–Ω—Ç –≤ –ª–µ–Ω—Ç–µ',text:'–ü—É–±–ª–∏–∫—É–π —Ç–æ–ª—å–∫–æ —Ç–æ, –∑–∞ —á—Ç–æ –Ω–µ —Å—Ç—ã–¥–Ω–æ. –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–º–µ—Å—Ç–Ω—ã–º –∏ –Ω–µ –Ω–∞—Ä—É—à–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≤—ã—à–µ.'},
  {title:'–ù–∞—Ä—É—à–µ–Ω–∏—è',text:'–ü—Ä–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–∏ –ø—Ä–∞–≤–∏–ª –∞–∫–∫–∞—É–Ω—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±–µ–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è. –ü—Ä–∞–≤–∏–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –≤—Å–µ—Ö.'},
];

(function(){const t=localStorage.getItem('th')||'dark';document.documentElement.setAttribute('data-theme',t);})();

function renderThemes(){
  const cur=localStorage.getItem('th')||'dark';
  document.getElementById('themeGrid').innerHTML=THEMES.map(t=>
    `<button class="theme-btn${t.id===cur?' sel':''}"
      style="background:${t.bg};color:${t.ac};border-color:${t.id===cur?t.ac:'transparent'}!important;"
      onclick="applyTheme('${t.id}')"><span style="font-size:1rem;">‚óè</span>${t.name}</button>`
  ).join('');
}
function applyTheme(id){localStorage.setItem('th',id);document.documentElement.setAttribute('data-theme',id);renderThemes();toast('–¢–µ–º–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞');}

function renderRules(){
  document.getElementById('rulesBody').innerHTML=RULES.map((r,i)=>`
    <div class="rule-card" style="animation-delay:${i*0.05}s">
      <div class="rule-num">–ü–†–ê–í–ò–õ–û ${i+1}</div>
      <div class="rule-title">${r.title}</div>
      <div class="rule-text">${r.text}</div>
    </div>`).join('');
}

// NAV
function go(id){
  const cur=document.querySelector('.screen.active');
  if(cur&&cur.id!==id) hist.push(cur.id);
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function goBack(){
  stopChat();
  const prev=hist.pop()||'s-main';
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(prev).classList.add('active');
  if(prev==='s-main') refreshTab();
}
function goMain(){
  stopChat();
  hist=[];
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('s-main').classList.add('active');
  switchBnav('chats');
  refreshTab();
}
function stopChat(){clearInterval(msgInt);clearInterval(statInt);msgInt=null;statInt=null;}

function switchBnav(active){
  ['chats','calls','feed','profile','rules'].forEach(x=>{
    ['','2','3','4'].forEach(s=>{
      const el=document.getElementById('bn-'+x+s);
      if(el) el.classList.toggle('active',x===active);
    });
  });
}
function goFeed(){switchBnav('feed');go('s-feed');loadFeed();}
function goProfile(){switchBnav('profile');go('s-profile');loadMyProfile();}
function goRules(){switchBnav('rules');go('s-rules');}
function goCalls(){switchBnav('calls');go('s-calls');loadCallHistory();}

async function loadCallHistory(){
  const res = await fetch('/api/call/history/' + myId);
  const history = await res.json();
  const body = document.getElementById('callHistBody');
  if(!history.length){
    body.innerHTML='<div style="text-align:center;color:var(--text-muted);padding:40px 20px;font-size:.88rem;">üìû<br><br>–ó–≤–æ–Ω–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
    return;
  }
  body.innerHTML=history.map(c=>{
    const date=new Date(c.time);
    const dateStr=date.toLocaleDateString('ru',{day:'2-digit',month:'short'})+' '+date.toLocaleTimeString('ru',{hour:'2-digit',minute:'2-digit'});
    const dur=c.duration?formatDur(c.duration):'–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
    const ico=c.isOutgoing?'üì§':'üì•';
    return `<div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--surface2);border-radius:12px;margin-bottom:8px;">
      <div style="font-size:1.6rem;">${ico}</div>
      <div style="flex:1;">
        <div style="font-weight:bold;font-size:.92rem;">${esc(c.partnerName)}</div>
        <div style="font-size:.75rem;color:var(--text-muted);">${c.isOutgoing?'–ò—Å—Ö–æ–¥—è—â–∏–π':'–í—Ö–æ–¥—è—â–∏–π'} ¬∑ ${dur}</div>
      </div>
      <div style="font-size:.72rem;color:var(--text-muted);">${dateStr}</div>
    </div>`;
  }).join('');
}

// TOAST
function toast(msg,type=''){
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div');
  el.className='toast'+(type==='ok'?' ok':type==='err'?' err':'');
  el.textContent=msg;
  document.getElementById('app').appendChild(el);
  setTimeout(()=>el.remove(),2400);
}

// API
async function post(url,body){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});return r.json();}
async function get(url){return(await fetch(url)).json();}

// AUTH
function setAuthMode(m){
  authMode=m;
  document.getElementById('atab-login').classList.toggle('active',m==='login');
  document.getElementById('atab-reg').classList.toggle('active',m==='reg');
  document.getElementById('aBtn').textContent=m==='login'?'–í–û–ô–¢–ò':'–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨–°–Ø';
  document.getElementById('aMsg').textContent='';
}
async function doAuth(){
  const username=document.getElementById('aName').value.trim();
  const password=document.getElementById('aPass').value;
  const msg=document.getElementById('aMsg');
  if(!username||!password){msg.textContent='–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è';return;}
  try{
    if(authMode==='reg'){
      if(username.length<2){msg.textContent='–ò–º—è –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞';return;}
      if(!/^[a-zA-Z–∞-—è–ê-–Ø—ë–Å0-9_]+$/.test(username)){msg.textContent='–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ _';return;}
      const r=await post('/api/register',{username,password});
      if(!r.success){msg.textContent=r.error==='taken'?'–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ':'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏';return;}
      myId=r.id;myUser=r.displayName;
    }else{
      const r=await post('/api/login',{username,password});
      if(!r.success){msg.textContent=r.error==='banned'?'–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω':'–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å';return;}
      myId=r.id;myUser=r.username;
    }
    localStorage.setItem('_id',myId);localStorage.setItem('_un',myUser);
    onLogin();
  }catch(e){msg.textContent='–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º';}
}
function onLogin(){
  hist=[];startPing();
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–¥–º–∏–Ω–∞
  const rawName=(myUser||'').replace(/^\[.*?\]\s*/,'').toLowerCase();
  if(rawName==='adminjs'){
    go('s-admin');loadAdminUsers();return;
  }
  loadMyProfile();go('s-main');switchTab('chats');switchBnav('chats');
}
function startPing(){const p=()=>post('/api/ping',{userId:myId}).catch(()=>{});p();setInterval(p,20000);}

// TABS
function switchTab(t){
  tab=t;
  ['chats','groups','channels'].forEach(x=>{
    document.getElementById('tab-'+x).classList.toggle('active',x===t);
    const sr=document.getElementById('sr-'+x);
    if(sr) sr.style.display=x===t?'flex':'none';
  });
  document.getElementById('mainTitle').textContent=t==='chats'?'–ß–ê–¢–´':t==='groups'?'–ì–†–£–ü–ü–´':'–ö–ê–ù–ê–õ–´';
  refreshTab();
}
function refreshTab(){if(tab==='chats')loadChats();else if(tab==='groups')loadGroups();else loadChannels();}

// CHATS
async function loadChats(){
  const b=document.getElementById('listBody');
  b.innerHTML='<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    const list=await get(`/api/chats/${myId}`);
    if(!list.length){b.innerHTML='<div class="empty-hint">–ù–µ—Ç —á–∞—Ç–æ–≤.<br>–ù–∞–π–¥–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –ø–æ —é–∑–µ—Ä–Ω–µ–π–º—É ‚Üë</div>';return;}
    b.innerHTML=list.map((c,i)=>`
      <div class="chat-item" style="animation-delay:${i*0.04}s" onclick="openChat('${c.id}','${esc(c.username)}')">
        ${avHtml(c.username,c.avatar,44,c.id)}
        <div class="ci">
          <div class="ci-name">${esc(c.username)}</div>
          <div class="ci-sub" style="display:flex;align-items:center;gap:5px;">${c.online?`<span class="online-pulse"></span>–æ–Ω–ª–∞–π–Ω`:'‚ö´ –æ—Ñ—Ñ–ª–∞–π–Ω'}</div>
        </div>
        ${c.unread>0?`<div class="ubadge">${c.unread>99?'99+':c.unread}</div>`:''}
      </div>`).join('');
  }catch(e){b.innerHTML='<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';}
}
async function findUser(){
  const u=document.getElementById('searchUser').value.trim().replace(/^@/,'');
  if(!u) return;
  try{
    const r=await get(`/api/user/find/${encodeURIComponent(u)}`);
    if(!r.id){toast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω','err');return;}
    document.getElementById('searchUser').value='';
    openChat(r.id,r.username);
  }catch(e){toast('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞','err');}
}
function openChat(id,name){
  stopChat();targetId=id;targetName=name;chatType='direct';grpId=null;
  document.getElementById('chatName').textContent=name;
  document.getElementById('chatStatus').textContent='';
  document.getElementById('chatStatus').className='chat-hstatus';
  setAv('chatAv',id,name);
  go('s-chat');
  loadMsgs();updateStat();
  msgInt=setInterval(loadMsgs,2500);
  statInt=setInterval(updateStat,3000);
}
function setAv(elId,id,name){
  const el=document.getElementById(elId);
  el.innerHTML='';el.textContent=(name||'?')[0].toUpperCase();el.style.background=strColor(name);
  if(id) get(`/api/profile/${id}`).then(p=>{if(p&&p.avatar)el.innerHTML=`<img src="${p.avatar}" loading="lazy">`;}).catch(()=>{});
}
async function updateStat(){
  if(!targetId||chatType!=='direct') return;
  try{
    const [r, t] = await Promise.all([
      get(`/api/status/${targetId}`),
      get(`/api/typing/${targetId}/${myId}`)
    ]);
    const el=document.getElementById('chatStatus');
    if(t && t.typing){
      el.className='chat-hstatus online';
      el.innerHTML=`<span class="typing-dots"><span></span><span></span><span></span></span> –ø–µ—á–∞—Ç–∞–µ—Ç...`;
    } else {
      el.className='chat-hstatus'+(r.online?' online':'');
      el.innerHTML=r.online
        ? `<span style="display:inline-flex;align-items:center;gap:4px;"><span class="online-pulse" style="width:7px;height:7px;"></span>–æ–Ω–ª–∞–π–Ω</span>`
        : (r.lastSeen?`–±—ã–ª(–∞) ${ago(r.lastSeen)}`:'–æ—Ñ—Ñ–ª–∞–π–Ω');
    }
  }catch(e){}
}
let typingTimer=null;
function onTyping(){
  if(!targetId||chatType!=='direct') return;
  post('/api/typing',{fromId:myId,toId:targetId}).catch(()=>{});
}
async function loadMsgs(){
  const url=chatType==='group'&&grpId?`/api/group-messages/${grpId}`:(targetId?`/api/messages/${myId}/${targetId}`:null);
  if(!url) return;
  try{
    const msgs=await get(url);
    const h=document.getElementById('chatHist');
    const atBot=h.scrollHeight-h.scrollTop<=h.clientHeight+80;
    h.innerHTML=msgs.length?msgs.map(m=>renderMsg(m)).join(''):'<div class="empty-hint">üëã –ù–∞–ø–∏—à–∏ –ø–µ—Ä–≤—ã–º!</div>';
    if(atBot) h.scrollTop=h.scrollHeight;
  }catch(e){}
}
const EMOJIS=['‚ù§Ô∏è','üòÇ','üëç','üòÆ','üò¢','üî•','üëè'];
function renderMsg(m){
  const mine=m.fromId===myId;
  const msgId=m.id||(m.fromId+'_'+m.time);
  const sender=!mine&&chatType==='group'?`<div class="ms">${esc(m.fromName||m.fromId)}</div>`:'';
  const photo=m.photo?`<img class="msg-photo" loading="lazy" src="${m.photo}" onclick="viewPhoto('${m.photo.replace(/'/g,"\\'")}')">` :'';
  const reactions=m.reactions||{};
  const reactionHtml=Object.entries(reactions).filter(([,u])=>u.length>0).map(([emoji,users])=>
    `<span class="reaction-chip${users.includes(myId)?' mine':''}" onclick="toggleReaction('${msgId}','${emoji}')">${emoji} ${users.length}</span>`
  ).join('');
  const replyQuote=m.replyToText?`<div class="reply-quote">‚Ü© <b>${esc(m.replyToName||'')}</b>: ${esc(m.replyToText.slice(0,60))}</div>`:'';

  // –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–≤–æ–Ω–∫–∞
  if(m.text && m.text.startsWith('__CALL__:')) {
    const parts = m.text.split(':');
    const roomName = parts[1];
    const callCard = `<div style="display:flex;flex-direction:column;gap:8px;min-width:180px;">
      <div style="display:flex;align-items:center;gap:8px;font-weight:bold;">
        <span style="font-size:1.3rem;">üìû</span>
        <span>${mine ? '–ò—Å—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫' : '–í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫'}</span>
      </div>
      <button onclick="joinCallFromCard('${roomName}')" style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:bold;font-size:.82rem;">
        üìû –í–æ–π—Ç–∏ –≤ –∑–≤–æ–Ω–æ–∫
      </button>
      <div class="mt">${m.time?fmtTime(m.time):''}</div>
    </div>`;
    return `<div class="mw ${mine?'my':'their'}" id="msg-${msgId}">
      ${sender}<div class="mb">${callCard}</div>
    </div>`;
  }

  return `<div class="mw ${mine?'my':'their'}" id="msg-${msgId}">
    ${sender}
    <div class="mb" oncontextmenu="showMsgMenu(event,'${msgId}',${mine},'${esc(m.text||'')}','${esc(m.fromName||m.fromId||'')}');return false;" ontouchstart="startLongPress(event,'${msgId}',${mine},'${esc(m.text||'')}','${esc(m.fromName||m.fromId||'')}')">
      ${replyQuote}${photo}${m.text?esc(m.text):''}<div class="mt">${m.time?fmtTime(m.time):''}</div>
    </div>
    ${reactionHtml?`<div class="reactions-row">${reactionHtml}</div>`:''}
  </div>`;
}

let longPressTimer=null;
function startLongPress(e,msgId,mine,text,fromName){
  longPressTimer=setTimeout(()=>showMsgMenu(e,msgId,mine,text,fromName),550);
}
document.addEventListener('touchend',()=>clearTimeout(longPressTimer));
document.addEventListener('touchmove',()=>clearTimeout(longPressTimer));

let replyTo=null;
function showMsgMenu(e,msgId,mine,text,fromName){
  e.preventDefault();
  closeModal();
  const picker=document.createElement('div');
  picker.className='reaction-picker';
  picker.id='rpicker';
  // –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä—É–µ–º —Ä—è–¥–æ–º —Å —Ç–∞–ø–æ–º
  const y=e.touches?e.touches[0].clientY:e.clientY;
  const x=e.touches?e.touches[0].clientX:e.clientX;
  picker.style.cssText=`top:${Math.min(y-50,window.innerHeight-80)}px;left:${Math.max(Math.min(x-120,window.innerWidth-290),8)}px;`;
  picker.innerHTML=EMOJIS.map(em=>
    `<button onclick="toggleReaction('${msgId}','${em}');document.getElementById('rpicker')?.remove();">${em}</button>`
  ).join('')+
  `<button onclick="setReply('${msgId}','${text}','${fromName}');document.getElementById('rpicker')?.remove();" title="–û—Ç–≤–µ—Ç–∏—Ç—å">‚Ü©</button>`+
  (mine?`<button onclick="deleteMsg('${msgId}');document.getElementById('rpicker')?.remove();" title="–£–¥–∞–ª–∏—Ç—å" style="color:#e53935;">üóë</button>`:'');
  document.getElementById('app').appendChild(picker);
  setTimeout(()=>document.addEventListener('click',()=>document.getElementById('rpicker')?.remove(),{once:true}),100);
}

function setReply(msgId,text,name){
  replyTo={id:msgId,text,name};
  const prev=document.getElementById('replyBar');
  if(prev) prev.remove();
  const bar=document.createElement('div');
  bar.id='replyBar';bar.className='reply-preview';
  bar.style.cssText='margin:0 11px 6px;flex-shrink:0;';
  bar.innerHTML=`<div class="reply-preview-text">‚Ü© <b>${esc(name)}</b>: ${esc(text.slice(0,60))}</div><button class="ghost" onclick="cancelReply()" style="padding:4px 8px;">‚úï</button>`;
  document.querySelector('#s-chat .input-area').before(bar);
}
function cancelReply(){replyTo=null;document.getElementById('replyBar')?.remove();}

async function toggleReaction(msgId,emoji){
  const ctype=chatType==='group'?'group':'direct';
  await post('/api/reactions',{msgId,userId:myId,emoji,chatType:ctype}).catch(()=>{});
  loadMsgs();
}
async function deleteMsg(msgId){
  await post('/api/messages/delete',{msgId,userId:myId,chatType:chatType==='group'?'group':'direct'}).catch(()=>{});
  loadMsgs();
}
async function sendMsg(){
  const inp=document.getElementById('msgIn');
  const text=inp.value.trim();
  if(!text||!myId) return;
  inp.value='';
  const rTo=replyTo;cancelReply();
  const body=rTo?{replyToId:rTo.id,replyToText:rTo.text,replyToName:rTo.name}:{};
  const msgBody=chatType==='group'
    ?{fromId:myId,groupId:grpId,text,...body}
    :{fromId:myId,toId:targetId,text,...body};
  const url=chatType==='group'?'/api/group-messages':'/api/messages';
  try{
    const r=await post(url,msgBody);
    if(r&&r.queued){
      // SW –ø–æ—Å—Ç–∞–≤–∏–ª –≤ –æ—á–µ—Ä–µ–¥—å (–æ—Ñ—Ñ–ª–∞–π–Ω)
      toast('–ù–µ—Ç —Å–µ—Ç–∏ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚è≥','info');
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —á–∞—Ç–µ –∫–∞–∫ "–≤ –æ—á–µ—Ä–µ–¥–∏"
      const h=document.getElementById('chatHistory');
      if(h){const d=document.createElement('div');d.className='mw my msg-queued';
        d.innerHTML=`<div class="mb"><span>${esc(text)}</span><div class="mt">${fmtTime(Date.now())}</div></div>`;
        h.appendChild(d);h.scrollTop=h.scrollHeight;}
    } else {
      loadMsgs();
    }
  }catch(e){
    // –ù–µ—Ç —Å–µ—Ç–∏ –∏ SW –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
    await localOutboxAdd(url,msgBody);
    toast('–ù–µ—Ç —Å–µ—Ç–∏ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚è≥','info');
  }
}
async function sendPhoto(input){
  const file=input.files[0];if(!file) return;
  if(file.size>5*1024*1024){toast('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å 5MB)','err');return;}
  input.value='';
  toast('–ó–∞–≥—Ä—É–∂–∞—é...','info');
  try{
    const url=await uploadFile(file);
    if(chatType==='group') await post('/api/group-messages',{fromId:myId,groupId:grpId,text:'',photo:url});
    else await post('/api/messages',{fromId:myId,toId:targetId,text:'',photo:url});
    loadMsgs();
  }catch(e){toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ç–æ','err');}
}
// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
async function uploadFile(file){
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º FormData (multer)
  try{
    const form=new FormData();form.append('file',file);
    const r=await fetch('/api/upload',{method:'POST',body:form});
    const d=await r.json();
    if(d.success) return d.url;
  }catch(e){}
  // Fallback: base64 ‚Üí JSON endpoint
  const base64=await new Promise((res,rej)=>{
    const rd=new FileReader();rd.onload=ev=>res(ev.target.result);rd.onerror=rej;rd.readAsDataURL(file);
  });
  const ext=(file.type.split('/')[1]||'jpg').split('+')[0];
  const r=await fetch('/api/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data:base64,ext})});
  const d=await r.json();
  if(d.success) return d.url;
  return base64; // –ø–æ—Å–ª–µ–¥–Ω–∏–π fallback ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π base64
}

// GROUPS
async function loadGroups(){
  const b=document.getElementById('listBody');
  b.innerHTML='<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    const list=await get(`/api/groups/${myId}`);
    if(!list.length){b.innerHTML='<div class="empty-hint">–ù–µ—Ç –≥—Ä—É–ø–ø.<br>–í—Å—Ç—É–ø–∏ –ø–æ ID –∏–ª–∏ —Å–æ–∑–¥–∞–π –Ω–æ–≤—É—é ‚Üë</div>';return;}
    b.innerHTML=list.map((g,i)=>`
      <div class="chat-item" style="animation-delay:${i*0.04}s" onclick="openGroup('${g.id}','${esc(g.name)}')">
        <div class="av" style="background:${strColor(g.name)};">üë•</div>
        <div class="ci">
          <div class="ci-name">${esc(g.name)}</div>
          <div class="ci-sub">ID: ${g.id} ¬∑ ${g.memberCount} —É—á–∞—Å—Ç–Ω.</div>
        </div>
      </div>`).join('');
  }catch(e){b.innerHTML='<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';}
}
function openGroup(id,name){
  stopChat();grpId=id;chatType='group';targetId=null;
  document.getElementById('chatName').textContent=name;
  document.getElementById('chatStatus').textContent=`ID: ${id}`;
  const el=document.getElementById('chatAv');el.innerHTML='';el.textContent='üë•';el.style.background=strColor(name);
  go('s-chat');loadMsgs();msgInt=setInterval(loadMsgs,2500);
}
async function joinGrpById(){
  const id=document.getElementById('searchGrp').value.trim().toUpperCase();if(!id) return;
  try{
    const r=await post('/api/groups/join',{groupId:id,userId:myId});
    if(r.success){document.getElementById('searchGrp').value='';toast('–í—Å—Ç—É–ø–∏–ª –≤ –≥—Ä—É–ø–ø—É!','ok');loadGroups();}
    else toast(r.error||'–ù–µ –Ω–∞–π–¥–µ–Ω–∞','err');
  }catch(e){toast('–û—à–∏–±–∫–∞','err');}
}
function showCreateGrp(){
  modal('–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É',`<input id="mGrpName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã..." autocorrect="off"><button onclick="createGrp()">–°–û–ó–î–ê–¢–¨</button>`);
}
async function createGrp(){
  const name=document.getElementById('mGrpName').value.trim();if(!name){toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','err');return;}
  try{
    const r=await post('/api/groups',{name,creatorId:myId});
    if(r.success){closeModal();toast(`–ì—Ä—É–ø–ø–∞ —Å–æ–∑–¥–∞–Ω–∞! ID: ${r.groupId}`,'ok');loadGroups();}
    else toast(r.error||'–û—à–∏–±–∫–∞','err');
  }catch(e){toast('–û—à–∏–±–∫–∞','err');}
}

// CHANNELS
async function loadChannels(){
  const b=document.getElementById('listBody');
  b.innerHTML='<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    const list=await get(`/api/channels/${myId}`);
    if(!list.length){b.innerHTML='<div class="empty-hint">–ù–µ—Ç –∫–∞–Ω–∞–ª–æ–≤.<br>–ü–æ–¥–ø–∏—à–∏—Å—å –ø–æ ID –∏–ª–∏ —Å–æ–∑–¥–∞–π —Å–≤–æ–π ‚Üë</div>';return;}
    b.innerHTML=list.map((c,i)=>`
      <div class="chat-item" style="animation-delay:${i*0.04}s" onclick="openChan('${c.id}','${esc(c.name)}')">
        <div class="av" style="background:${strColor(c.name)};">üì¢</div>
        <div class="ci">
          <div class="ci-name">${esc(c.name)}</div>
          <div class="ci-sub">ID: ${c.id} ¬∑ ${c.subCount} –ø–æ–¥–ø–∏—Å—á.</div>
        </div>
      </div>`).join('');
  }catch(e){b.innerHTML='<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';}
}
async function subChanById(){
  const id=document.getElementById('searchChan').value.trim().toUpperCase();if(!id) return;
  try{
    const r=await post('/api/channels/subscribe',{channelId:id,userId:myId});
    if(r.success){document.getElementById('searchChan').value='';toast('–ü–æ–¥–ø–∏—Å–∞–Ω!','ok');loadChannels();}
    else toast(r.error||'–ù–µ –Ω–∞–π–¥–µ–Ω','err');
  }catch(e){toast('–û—à–∏–±–∫–∞','err');}
}
function showCreateChan(){
  modal('–°–æ–∑–¥–∞—Ç—å –∫–∞–Ω–∞–ª',`
    <input id="mChanName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞..." autocorrect="off">
    <input id="mChanDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." autocorrect="off">
    <button onclick="createChan()">–°–û–ó–î–ê–¢–¨</button>`);
}
async function createChan(){
  const name=document.getElementById('mChanName').value.trim();const desc=document.getElementById('mChanDesc').value.trim();
  if(!name){toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ','err');return;}
  try{
    const r=await post('/api/channels',{name,desc,ownerId:myId});
    if(r.success){closeModal();toast(`–ö–∞–Ω–∞–ª —Å–æ–∑–¥–∞–Ω! ID: ${r.channelId}`,'ok');loadChannels();}
    else toast(r.error||'–û—à–∏–±–∫–∞','err');
  }catch(e){toast('–û—à–∏–±–∫–∞','err');}
}
async function openChan(id,name){
  chanId=id;document.getElementById('chanTitle').textContent=name;
  try{const info=await get(`/api/channels/info/${id}`);document.getElementById('postBtn').style.display=info.ownerId===myId?'block':'none';}
  catch(e){document.getElementById('postBtn').style.display='none';}
  go('s-channel');loadChanPosts();
}
async function loadChanPosts(){
  const b=document.getElementById('chanBody');
  try{
    const posts=await get(`/api/channels/${chanId}/posts?viewerId=${myId}`);
    if(!posts.length){b.innerHTML='<div class="empty-hint">–ü–æ—Å—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';return;}
    b.innerHTML=[...posts].reverse().map(p=>`
      <div class="chan-post-card">
        <div class="post-head">
          <div class="post-av">${(p.authorName||'?')[0].toUpperCase()}</div>
          <div><div class="post-author">${esc(p.authorName)}</div><div class="post-time-small">${fmtTime(p.time)}</div></div>
        </div>
        ${p.photo?`<img class="post-img" src="${p.photo}" onclick="viewPhoto('${p.photo}')">` :''}
        ${p.text?`<div class="post-text">${esc(p.text)}</div>`:''}
        <div class="post-meta">üëÅ ${p.views||0} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</div>
      </div>`).join('');
  }catch(e){b.innerHTML='<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';}
}
function showPostModal(){
  modal('–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª',`
    <textarea id="mPostText" placeholder="–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞..." rows="4" style="resize:none;"></textarea>
    <button onclick="publishPost()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>`);
}
async function publishPost(){
  const text=document.getElementById('mPostText').value.trim();if(!text){toast('–í–≤–µ–¥–∏ —Ç–µ–∫—Å—Ç','err');return;}
  try{
    const r=await post(`/api/channels/${chanId}/posts`,{authorId:myId,text});
    if(r.success){closeModal();toast('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!','ok');loadChanPosts();}
    else toast(r.error||'–û—à–∏–±–∫–∞','err');
  }catch(e){toast('–û—à–∏–±–∫–∞','err');}
}

// FEED
async function loadFeed(){
  const b=document.getElementById('feedBody');
  b.innerHTML='<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    const r=await get(`/api/feed?userId=${myId}`);
    if(!r||!r.length){b.innerHTML='<div class="empty-hint">–õ–µ–Ω—Ç–∞ –ø—É—Å—Ç–∞.<br>–ë—É–¥—å –ø–µ—Ä–≤—ã–º ‚Äî –Ω–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å! ‚úèÔ∏è</div>';return;}
    b.innerHTML=r.map((p,i)=>`
      <div class="post-card" style="animation-delay:${i*0.05}s">
        <div class="post-head">
          <div class="post-av" style="background:${strColor(p.authorName)};">${(p.authorName||'?')[0].toUpperCase()}</div>
          <div>
            <div class="post-author">${esc(p.authorName)}</div>
            <div class="post-time-small">${fmtTime(p.time)}</div>
          </div>
        </div>
        ${p.title?`<div class="post-title">${esc(p.title)}</div>`:''}
        ${p.photo?`<img class="post-img" src="${p.photo}" onclick="viewPhoto('${p.photo}')">` :''}
        ${p.text?`<div class="post-text">${esc(p.text)}</div>`:''}
        <div class="post-meta">üëÅ ${p.views||0}</div>
      </div>`).join('');
  }catch(e){b.innerHTML='<div class="empty-hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';}
}
function showComposeModal(){
  modal('–ù–æ–≤—ã–π –ø–æ—Å—Ç –≤ –ª–µ–Ω—Ç—É',`
    <input id="mFeedTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)..." autocorrect="off">
    <textarea id="mFeedText" placeholder="–ß—Ç–æ —É —Ç–µ–±—è –Ω–æ–≤–æ–≥–æ?..." rows="4" style="resize:none;"></textarea>
    <div style="display:flex;gap:8px;align-items:center;">
      <input type="file" id="mFeedPhoto" accept="image/*" style="display:none" onchange="previewFeedPhoto(this)">
      <button class="sec" onclick="document.getElementById('mFeedPhoto').click()" style="width:auto;padding:10px 13px;">üì∑ –§–æ—Ç–æ</button>
      <span id="mFeedPhotoName" style="font-size:.8rem;color:var(--text-muted);"></span>
    </div>
    <div id="mFeedPreview"></div>
    <button onclick="publishFeedPost()">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>`);
}
let feedPhotoData=null;
let feedPhotoFile=null;
function previewFeedPhoto(input){
  const file=input.files[0];if(!file) return;
  if(file.size>5*1024*1024){toast('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å 5MB)','err');return;}
  feedPhotoFile=file;
  document.getElementById('mFeedPhotoName').textContent=file.name;
  const reader=new FileReader();
  reader.onload=e=>{
    feedPhotoData=e.target.result; // —Ç–æ–ª—å–∫–æ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    document.getElementById('mFeedPreview').innerHTML=`<img src="${feedPhotoData}" style="width:100%;border-radius:9px;margin-top:4px;">`;
  };
  reader.readAsDataURL(file);
}
async function publishFeedPost(){
  const title=document.getElementById('mFeedTitle').value.trim();
  const text=document.getElementById('mFeedText').value.trim();
  if(!text&&!feedPhotoFile){toast('–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–ª–∏ –¥–æ–±–∞–≤—å —Ñ–æ—Ç–æ','err');return;}
  try{
    let photoUrl='';
    if(feedPhotoFile){
      toast('–ó–∞–≥—Ä—É–∂–∞—é —Ñ–æ—Ç–æ...','info');
      photoUrl=await uploadFile(feedPhotoFile);
    }
    const r=await post('/api/feed',{authorId:myId,title,text,photo:photoUrl});
    feedPhotoData=null;feedPhotoFile=null;
    if(r.success){closeModal();toast('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!','ok');loadFeed();}
    else toast(r.error||'–û—à–∏–±–∫–∞','err');
  }catch(e){toast('–û—à–∏–±–∫–∞','err');}
}

// PROFILE
async function loadMyProfile(){
  if(!myId) return;
  try{
    const p=await get(`/api/profile/${myId}`);
    document.getElementById('myName').textContent=p.username||myUser;
    document.getElementById('myIdLabel').textContent=`ID: ${myId}`;
    document.getElementById('myBio').value=p.bio||'';
    setAvBig('myAv',myId,p.avatar,p.username||myUser);
  }catch(e){}
}
function setAvBig(elId,id,avatarUrl,name){
  const el=document.getElementById(elId);
  if(avatarUrl){el.innerHTML=`<img src="${avatarUrl}" loading="lazy">`;}  // URL, –Ω–µ base64
  else{el.innerHTML='';el.textContent=(name||'?')[0].toUpperCase();el.style.background=strColor(name);}
}
async function saveBio(){const bio=document.getElementById('myBio').value.trim();await post('/api/bio',{userId:myId,bio});toast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!','ok');}
async function changeUsername(){
  const n=document.getElementById('newName').value.trim();if(!n){toast('–í–≤–µ–¥–∏ –Ω–æ–≤–æ–µ –∏–º—è','err');return;}
  try{
    const r=await post('/api/change-username',{userId:myId,newUsername:n});
    if(r.success){myUser=r.username;localStorage.setItem('_un',myUser);document.getElementById('myName').textContent=myUser;document.getElementById('newName').value='';toast('–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ!','ok');}
    else toast(r.error||'–û—à–∏–±–∫–∞','err');
  }catch(e){toast('–û—à–∏–±–∫–∞','err');}
}
function pickAvatar(){
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
  inp.onchange=async e=>{
    const file=e.target.files[0];if(!file) return;
    if(file.size>2*1024*1024){toast('–§–æ—Ç–æ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å 2MB)','err');return;}
    toast('–ó–∞–≥—Ä—É–∂–∞—é –∞–≤–∞—Ç–∞—Ä...','info');
    try{
      const url=await uploadFile(file);
      await post('/api/avatar',{userId:myId,avatar:url});
      // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage ‚Äî —Ç–æ–ª—å–∫–æ URL
      loadMyProfile();toast('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!','ok');
    }catch(err){toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞','err');}
  };
  inp.click();
}

// USER PROFILE
function openViewedProfile(){if(!targetId||chatType!=='direct') return;viewProfile(targetId,targetName);}
function viewProfile(id,name){
  upId=id;upName=name;
  get(`/api/profile/${id}`).then(p=>{
    document.getElementById('upName').textContent=p.username||name||id;
    document.getElementById('upBio').textContent=p.bio||'';
    setAvBig('upAv',id,p.avatar,p.username||name);
    go('s-uprofile');
  }).catch(()=>toast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è','err'));
}
function msgViewedUser(){if(!upId) return;goBack();openChat(upId,upName||upId);}

// LOGOUT
function logout(){
  stopChat();myId=null;myUser=null;
  localStorage.removeItem('_id');localStorage.removeItem('_un');
  hist=[];
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('s-auth').classList.add('active');
  document.getElementById('aName').value='';document.getElementById('aPass').value='';document.getElementById('aMsg').textContent='';
}

// SHIELD
function showShield(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789!@#$%';
  let pass='';
  const arr=new Uint8Array(20);
  crypto.getRandomValues(arr);
  arr.forEach(b=>pass+=chars[b%chars.length]);
  modal('üõ° –ó–ê–©–ò–¢–ò –ú–ï–ù–Ø! üõ°',`
    <div style="font-size:.85rem;color:var(--text-muted);line-height:1.6;">
      –ù–∏–∂–µ ‚Äî –Ω–∞–¥—ë–∂–Ω—ã–π —Å–ª—É—á–∞–π–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è —Ç–≤–æ–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.<br>
      <b>–°–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –≤ –Ω–∞–¥—ë–∂–Ω–æ–º –º–µ—Å—Ç–µ</b> –ø—Ä–µ–∂–¥–µ —á–µ–º –º–µ–Ω—è—Ç—å!
    </div>
    <div class="shield-pass" id="shieldPass">${pass}</div>
    <button onclick="copyShield()">üìã –°–ö–û–ü–ò–†–û–í–ê–¢–¨</button>
    <button class="sec" onclick="closeModal()">–ó–ê–ö–†–´–¢–¨</button>`);
}
function copyShield(){
  const t=document.getElementById('shieldPass').textContent;
  navigator.clipboard.writeText(t).then(()=>toast('–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!','ok')).catch(()=>toast('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å','err'));
}

// MODAL
function modal(title,content){
  closeModal();
  const ov=document.createElement('div');ov.className='modal-ov';ov.id='mOv';
  ov.innerHTML=`<div class="modal-box">
    <div class="modal-head"><div class="modal-title">${title}</div><button class="ghost" onclick="closeModal()" style="font-size:1.1rem;">‚úï</button></div>
    ${content}</div>`;
  ov.addEventListener('click',e=>{if(e.target===ov)closeModal();});
  document.getElementById('app').appendChild(ov);
}
function closeModal(){const m=document.getElementById('mOv');if(m)m.remove();}

// PHOTO
function viewPhoto(src){
  const ov=document.createElement('div');ov.className='photo-ov';
  ov.innerHTML=`<img src="${src}">`;ov.onclick=()=>ov.remove();
  document.getElementById('app').appendChild(ov);
}

// UTILS
function esc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function strColor(s){
  const cols=['#ff6600','#7c6bff','#00aa44','#e040fb','#0099cc','#ff4466','#00ccaa'];
  let h=0;for(let i=0;i<(s||'').length;i++)h=(h*31+s.charCodeAt(i))&0xffff;
  return cols[h%cols.length];
}
function avHtml(name,url,sz,id){
  const s=`width:${sz}px;height:${sz}px;`;
  if(url) return `<div class="av" style="${s}"><img src="${url}" loading="lazy"></div>`;
  return `<div class="av" style="${s}background:${strColor(name)};">${(name||'?')[0].toUpperCase()}</div>`;
}
function fmtTime(ts){
  const d=new Date(ts),n=new Date();
  const hh=String(d.getHours()).padStart(2,'0'),mm=String(d.getMinutes()).padStart(2,'0');
  return d.toDateString()===n.toDateString()?`${hh}:${mm}`:`${d.getDate()}.${d.getMonth()+1} ${hh}:${mm}`;
}
function ago(ts){
  const s=Math.floor((Date.now()-ts)/1000);
  if(s<60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';if(s<3600) return `${Math.floor(s/60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
  if(s<86400) return `${Math.floor(s/3600)} —á. –Ω–∞–∑–∞–¥`;return `${Math.floor(s/86400)} –¥–Ω. –Ω–∞–∑–∞–¥`;
}


// ADMIN
async function loadAdminUsers(){
  const b=document.getElementById('adminList');
  b.innerHTML='<div class="empty-hint">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try{
    const r=await post('/api/admin/users',{adminId:myId});
    if(!r.success){b.innerHTML='<div class="empty-hint">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞</div>';return;}
    if(!r.users.length){b.innerHTML='<div class="empty-hint">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';return;}
    b.innerHTML=r.users.map((u,i)=>`
      <div class="admin-card" style="animation-delay:${i*0.04}s">
        <div style="flex:1;">
          <div style="font-size:.9rem;font-weight:bold;">${esc(u.username)}</div>
          <div style="font-size:.75rem;color:var(--text-muted);">ID: ${u.id}</div>
        </div>
        ${u.banned?'<span class="admin-badge">–ë–ê–ù</span>':''}
        ${u.banned
          ? `<button class="sec" style="padding:7px 12px;font-size:.8rem;" onclick="adminUnban('${u.id}')">–†–ê–ó–ë–ê–ù</button>`
          : `<button class="danger" style="padding:7px 12px;font-size:.8rem;" onclick="adminBan('${u.id}')">–ë–ê–ù</button>`
        }
      </div>`).join('');
  }catch(e){b.innerHTML='<div class="empty-hint">–û—à–∏–±–∫–∞</div>';}
}
async function adminBan(targetId){
  const r=await post('/api/admin/ban',{adminId:myId,targetId});
  if(r.success){toast('–ó–∞–±–∞–Ω–µ–Ω','ok');loadAdminUsers();}
  else toast(r.error||'–û—à–∏–±–∫–∞','err');
}
async function adminUnban(targetId){
  const r=await post('/api/admin/unban',{adminId:myId,targetId});
  if(r.success){toast('–†–∞–∑–±–∞–Ω–µ–Ω','ok');loadAdminUsers();}
  else toast(r.error||'–û—à–∏–±–∫–∞','err');
}
// INIT
renderThemes();
renderRules();
const _id=localStorage.getItem('_id'),_un=localStorage.getItem('_un');
if(_id&&_un){myId=_id;myUser=_un;onLogin();}


// ===== –ó–í–û–ù–û–ö –ß–ï–†–ï–ó JITSI =====
// ===== –ó–í–û–ù–ö–ò =====
let callStartTime = null;
let currentCallRoomName = null;
let currentCallTargetId = null;

function buildJitsiUrl(roomName) {
    // –ü–µ—Ä–µ–¥–∞—ë–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —á–µ—Ä–µ–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç URL (#config) —á—Ç–æ–±—ã –æ–±–æ–π—Ç–∏ Google-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
    // –∏ —Å—Ä–∞–∑—É –≤–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const displayName = encodeURIComponent(myUser || '–ì–æ—Å—Ç—å');
    const config = [
        'config.prejoinPageEnabled=false',           // —É–±–∏—Ä–∞–µ–º —ç–∫—Ä–∞–Ω –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        'config.requireDisplayName=false',           // –∏–º—è –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
        'config.disableDeepLinking=true',            // –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
        'userInfo.displayName=' + displayName        // —Å—Ä–∞–∑—É –∑–∞–¥–∞—ë–º –∏–º—è
    ].join('&');
    return 'https://meet.jit.si/' + roomName + '#' + config;
}

function startJitsiCall() {
    if(!targetId) return;
    const roomName = 'doverie-' + [myId, targetId].sort().join('-');
    const name = document.getElementById('chatName').textContent;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –≤ —á–∞—Ç
    post('/api/messages', {
        fromId: myId, toId: targetId,
        text: '__CALL__:' + roomName + ':' + buildJitsiUrl(roomName)
    }).then(() => loadMsgs());

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–≤–æ–Ω–æ–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    post('/api/call/start', { callerId: myId, callerName: myUser, targetId: targetId, channelName: roomName }).catch(()=>{});

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –∑–≤–æ–Ω–∫–∞
    openCallScreen(name, roomName, targetId);
}

function openCallScreen(name, roomName, tId) {
    currentCallRoomName = roomName;
    currentCallTargetId = tId || targetId;
    document.getElementById('callWithName').textContent = 'üìû ' + name;
    document.getElementById('jitsiFrame').src = buildJitsiUrl(roomName);
    callStartTime = Date.now();
    go('s-call');
}

function endJitsiCall() {
    const duration = callStartTime ? Math.floor((Date.now() - callStartTime) / 1000) : 0;
    const frame = document.getElementById('jitsiFrame');

    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º iframe ‚Äî —É–±–∏—Ä–∞–µ–º src –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º —ç–ª–µ–º–µ–Ω—Ç
    // —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω
    frame.src = 'about:blank';
    const parent = frame.parentNode;
    const newFrame = frame.cloneNode(false);
    newFrame.src = '';
    parent.replaceChild(newFrame, frame);
    newFrame.id = 'jitsiFrame';

    if(currentCallRoomName) {
        post('/api/call/end', {
            channelName: currentCallRoomName,
            callerId: myId,
            targetId: currentCallTargetId,
            duration
        }).catch(()=>{});
    }

    callStartTime = null;
    currentCallRoomName = null;
    currentCallTargetId = null;
    goBack();
}

// –û—Ç–∫—Ä—ã—Ç—å –∑–≤–æ–Ω–æ–∫ –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è-–∫–∞—Ä—Ç–æ—á–∫–∏
function joinCallFromCard(roomName) {
    const name = document.getElementById('chatName').textContent;
    openCallScreen(name, roomName, targetId);
}

</script>

<script>
// ‚îÄ‚îÄ Service Worker ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => {
        console.log('[SW] –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω', reg.scope);
        // –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç SW (MSG_SENT ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –æ—á–µ—Ä–µ–¥–∏ —É—à–ª–æ)
        navigator.serviceWorker.addEventListener('message', e => {
          if (e.data && e.data.type === 'MSG_SENT') {
            if (typeof loadMsgs === 'function') loadMsgs();
          }
        });
      })
      .catch(e => console.warn('[SW] –æ—à–∏–±–∫–∞:', e));
  });
}

// ‚îÄ‚îÄ Offline-–±–∞–Ω–Ω–µ—Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setOffline(offline) {
  const bar = document.getElementById('offline-bar');
  if (!bar) return;
  bar.classList.toggle('show', offline);
  // –°–¥–≤–∏–≥–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –≤–Ω–∏–∑ —á—Ç–æ–±—ã –±–∞–Ω–Ω–µ—Ä –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª
  document.body.style.paddingTop = offline ? bar.offsetHeight + 'px' : '';
}
window.addEventListener('online',  () => {
  setOffline(false);
  flushLocalOutbox(); // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
});
window.addEventListener('offline', () => setOffline(true));
setOffline(!navigator.onLine);

// ‚îÄ‚îÄ LocalOutbox (–∑–∞–ø–∞—Å–Ω–æ–π, –±–µ–∑ SW) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openOutboxDB() {
  return new Promise((res, rej) => {
    const r = indexedDB.open('doverie-outbox', 1);
    r.onupgradeneeded = ev =>
      ev.target.result.createObjectStore('outbox', { keyPath: 'id', autoIncrement: true });
    r.onsuccess = ev => res(ev.target.result);
    r.onerror = () => rej(r.error);
  });
}
async function localOutboxAdd(url, body) {
  try {
    const db = await openOutboxDB();
    const tx = db.transaction('outbox', 'readwrite');
    tx.objectStore('outbox').add({ url, body, ts: Date.now() });
  } catch(e) {}
}
async function flushLocalOutbox() {
  try {
    const db = await openOutboxDB();
    const tx = db.transaction('outbox', 'readwrite');
    const store = tx.objectStore('outbox');
    const items = await new Promise((res, rej) => {
      const r = store.getAll(); r.onsuccess = () => res(r.result); r.onerror = rej;
    });
    let sent = 0;
    for (const item of items) {
      try {
        const r = await fetch(item.url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(item.body)
        });
        if (r.ok) { store.delete(item.id); sent++; }
      } catch(e) {}
    }
    if (sent > 0 && typeof loadMsgs === 'function') {
      loadMsgs();
      if (typeof toast === 'function') toast(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ ${sent} —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –æ—á–µ—Ä–µ–¥–∏ ‚úì`, 'ok');
    }
  } catch(e) {}
}
// –ü—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—á–µ—Ä–µ–¥—å –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –µ—Å–ª–∏ –æ–Ω–ª–∞–π–Ω
if (navigator.onLine) flushLocalOutbox();
</script>
</body>
</html>
