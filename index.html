<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–î–æ–≤–µ—Ä–∏–µ v1.2.9 | Premium</title>
    <style>
        :root { 
            --bg-gradient: linear-gradient(135deg, #ff6600 0%, #ff9831 100%);
            --text-color: #222; 
            --box-bg: rgba(255, 255, 255, 0.95); 
            --accent: #ff6600; 
            --accent-hover: #e65c00;
            --sidebar-bg: #f8f9fa; 
            --shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        [data-theme="dark"] { 
            --bg-gradient: linear-gradient(135deg, #111 0%, #222 100%);
            --text-color: #ff6600; 
            --box-bg: rgba(30, 30, 30, 0.95); 
            --accent: #ff6600; 
            --sidebar-bg: #1a1a1a; 
            --shadow: 0 8px 30px rgba(0,0,0,0.5);
        }
        [data-theme="matrix"] { 
            --bg-gradient: #000;
            --text-color: #0f0; 
            --box-bg: rgba(5, 5, 5, 0.9); 
            --accent: #0f0; 
            --sidebar-bg: #0a0a0a; 
            --shadow: 0 0 20px rgba(0,255,0,0.2);
        }

        body { 
            margin: 0; 
            background: var(--bg-gradient); 
            color: var(--text-color); 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            justify-content: center; 
            transition: all 0.3s ease;
        }

        .app-container { 
            width: 100%; 
            max-width: 500px; 
            height: 100vh; 
            background: var(--box-bg); 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
        }
        
        /* –ê–ù–ò–ú–ê–¶–ò–ò */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .screen { display: none; flex: 1; flex-direction: column; overflow: hidden; animation: fadeIn 0.4s ease forwards; }
        .active-screen { display: flex; }

        .avatar { 
            width: 45px; height: 45px; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; 
            font-weight: bold; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex-shrink: 0;
        }

        .header { 
            padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(255,255,255,0.1);
        }

        .chat-item { 
            padding: 15px 20px; border-bottom: 1px solid rgba(0,0,0,0.03); 
            cursor: pointer; display: flex; align-items: center; gap: 15px; 
            transition: all 0.2s ease;
        }
        .chat-item:hover { background: rgba(0,0,0,0.02); transform: scale(1.01); }

        .chat-history { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
        
        .message { 
            padding: 10px 16px; border-radius: 18px; max-width: 80%; 
            font-size: 0.95rem; line-height: 1.4; animation: fadeIn 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .msg-my { background: var(--accent); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg-their { background: var(--sidebar-bg); align-self: flex-start; border-bottom-left-radius: 4px; }

        input, select { 
            padding: 12px 16px; border: 1px solid rgba(0,0,0,0.1); 
            background: white; color: #333; border-radius: 12px; 
            outline: none; transition: all 0.3s; font-size: 1rem;
        }
        [data-theme="dark"] input { background: #252525; color: #eee; border-color: #444; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255,102,0,0.2); }

        button { 
            padding: 12px 20px; border: none; border-radius: 12px; 
            background: var(--accent); color: white; font-weight: 600; 
            cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        button:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255,102,0,0.3); }
        button:active { transform: translateY(0); }

        .big-btn { width: 100%; margin-top: 10px; padding: 15px; }

        #pin-overlay { 
            position: absolute; inset: 0; background: var(--bg-gradient); 
            z-index: 1000; display: none; flex-direction: column; 
            align-items: center; justify-content: center; backdrop-filter: blur(20px);
        }

        .card { 
            background: var(--box-bg); padding: 20px; border-radius: 20px; 
            box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2);
        }
    </style>
</head>
<body>

    <div id="pin-overlay">
        <div class="card" style="text-align: center; width: 280px;">
            <h3 style="margin-top:0">SECURITY PIN</h3>
            <input type="password" id="pinInput" maxlength="4" placeholder="****" 
                   style="text-align: center; font-size: 2rem; width: 100%; letter-spacing: 10px;">
            <button class="big-btn" onclick="checkPin()">UNLOCK</button>
        </div>
    </div>

    <div class="app-container">
        <div id="auth-screen" class="screen active-screen" style="padding: 30px; overflow-y: auto;">
            <h1 style="text-align: center; margin-bottom: 30px; letter-spacing: -1px;">–î–û–í–ï–†–ò–ï <span style="font-weight: 300; opacity: 0.6;">v1.2.9</span></h1>
            
            <div class="card">
                <h4 style="margin: 0 0 15px 0; opacity: 0.5; font-size: 0.8rem; text-transform: uppercase;">New Account</h4>
                <input type="text" id="regName" placeholder="Username" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="regPass" placeholder="Password" style="width: 100%; margin-bottom: 10px;">
                <select id="platform" style="width: 100%; margin-bottom: 10px;">
                    <option value="app">Mobile App</option>
                    <option value="site">Web Version</option>
                </select>
                <button class="big-btn" onclick="register()">CREATE ACCOUNT</button>
            </div>

            <div class="card">
                <h4 style="margin: 0 0 15px 0; opacity: 0.5; font-size: 0.8rem; text-transform: uppercase;">Login</h4>
                <input type="text" id="loginId" placeholder="Your ID" style="width: 100%; margin-bottom: 10px;">
                <input type="password" id="loginPass" placeholder="Password" style="width: 100%; margin-bottom: 10px;">
                <button class="big-btn" onclick="login()">SIGN IN</button>
            </div>
            
            <p id="auth-msg" style="text-align: center; font-weight: bold; padding: 10px; border-radius: 10px;"></p>
        </div>

        <div id="list-screen" class="screen">
            <div class="header">
                <h3 id="display-my-name" style="margin:0">Messenger</h3>
                <button onclick="showSettings()" style="padding: 8px; background: transparent; color: var(--text-color); font-size: 1.2rem;">‚öô</button>
            </div>
            <div style="padding: 15px; display: flex; gap: 10px;">
                <input type="text" id="searchId" placeholder="Find by ID..." style="flex: 1; font-size: 0.9rem;">
                <button onclick="startChat(document.getElementById('searchId').value)" style="width: 45px; padding: 0;">üîç</button>
            </div>
            <div id="chat-list" style="flex: 1; overflow-y: auto;"></div>
        </div>

        <div id="chat-window" class="screen">
            <div class="header" style="background: var(--sidebar-bg);">
                <button onclick="showList()" style="background: transparent; color: var(--text-color); padding: 5px;">‚Üê</button>
                <div style="flex: 1; text-align: center;"><b id="chat-target-name">Chat</b></div>
                <div style="width: 35px;"></div>
            </div>
            <div class="chat-history" id="chat-history"></div>
            <div class="input-area" style="padding: 15px;">
                <input type="text" id="msgText" placeholder="Write a message..." style="flex: 1; border-radius: 25px;">
                <button onclick="sendMessage()" style="border-radius: 50%; width: 50px; height: 50px; padding: 0;">‚û§</button>
            </div>
        </div>

        <div id="settings-screen" class="screen" style="padding: 30px;">
            <h2 style="margin-top: 0;">Settings</h2>
            <div class="card">
                <label style="display: block; margin-bottom: 10px; font-size: 0.9rem;">Appearance</label>
                <select onchange="document.body.setAttribute('data-theme', this.value)" style="width: 100%;">
                    <option value="light">Classic Orange</option>
                    <option value="dark">Deep Dark</option>
                    <option value="matrix">Matrix Green</option>
                </select>
            </div>
            <div class="card">
                <label style="display: block; margin-bottom: 10px; font-size: 0.9rem;">Security PIN (4 digits)</label>
                <input type="password" id="setPin" maxlength="4" placeholder="Enter new PIN" style="width: 100%;">
                <button class="big-btn" onclick="saveSettings()" style="margin-top: 15px;">UPDATE PIN</button>
            </div>
            <button class="big-btn" onclick="applyLambda()">ACTIVATE Œª</button>
            <button class="big-btn" onclick="location.reload()" style="background: #ff4444; margin-top: 10px;">LOGOUT</button>
            <button class="big-btn" onclick="showList()" style="margin-top: auto; background: #999;">BACK</button>
        </div>
    </div>

    <script>
        // ... (–°–∫—Ä–∏–ø—Ç—ã –æ—Å—Ç–∞—é—Ç—Å—è –¢–ï –ñ–ï, —á—Ç–æ –≤ v1.2.8, —Ç–æ–ª—å–∫–æ –¥–æ–±–∞–≤—å –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏) ...
        let myId = null, currentTargetId = null, tempUsername = "";

        function getAvatar(name) {
            const colors = ['#FF5722', '#4CAF50', '#2196F3', '#FFC107', '#9C27B0', '#00BCD4'];
            const clearName = name.replace('[app] ', '').replace('[site] ', '');
            const char = clearName.charAt(0) || '?';
            const color = colors[char.charCodeAt(0) % colors.length];
            return `<div class="avatar" style="background:${color}">${char}</div>`;
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen'));
            document.getElementById(id).classList.add('active-screen');
        }

        async function register() {
            const username = document.getElementById('regName').value;
            const password = document.getElementById('regPass').value;
            const platform = document.getElementById('platform').value;
            if(!username || !password) return alert("Fill all fields!");

            const res = await fetch('/api/register', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password, platform})
            });
            const data = await res.json();
            if(data.success) {
                document.getElementById('auth-msg').style.background = "rgba(0,255,0,0.1)";
                document.getElementById('auth-msg').innerHTML = `SUCCESS! YOUR ID:<br><span style="font-size: 2.5rem;">${data.id}</span>`;
            }
        }

        async function login() {
            const id = document.getElementById('loginId').value.toUpperCase();
            const password = document.getElementById('loginPass').value;
            const res = await fetch('/api/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id, password})
            });
            
            if(res.ok) {
                const data = await res.json();
                myId = data.id;
                tempUsername = data.username;
                const savedPin = localStorage.getItem('app_pin_' + myId);
                if(savedPin) {
                    document.getElementById('pin-overlay').style.display = 'flex';
                } else {
                    enterApp();
                }
            } else alert('Wrong ID or Password');
        }

        function checkPin() {
            const savedPin = localStorage.getItem('app_pin_' + myId);
            if(document.getElementById('pinInput').value === savedPin) {
                document.getElementById('pin-overlay').style.display = 'none';
                enterApp(); 
            } else alert('Incorrect PIN');
        }

        function enterApp() {
            document.getElementById('display-my-name').innerText = tempUsername;
            showScreen('list-screen');
            loadChatList();
            if(window.listInt) clearInterval(window.listInt);
            window.listInt = setInterval(loadChatList, 5000);
        }

        async function loadChatList() {
            if(!myId || currentTargetId) return;
            const res = await fetch(`/api/chats/${myId}`);
            const chats = await res.json();
            document.getElementById('chat-list').innerHTML = chats.map(c => `
                <div class="chat-item" onclick="startChat('${c.id}', '${c.username}')">
                    ${getAvatar(c.username)}
                    <div style="flex:1">
                        <div style="font-weight:600">${c.username}</div>
                        <div style="font-size:0.75rem; opacity:0.5">ID: #${c.id}</div>
                    </div>
                    <div style="font-size:1.2rem; opacity:0.3">‚Ä∫</div>
                </div>`).join('');
        }

        function startChat(id, name) {
            if(!id) return;
            currentTargetId = id.toUpperCase();
            document.getElementById('chat-target-name').innerText = name || "#"+id;
            showScreen('chat-window');
            loadMessages();
            if(window.msgInterval) clearInterval(window.msgInterval);
            window.msgInterval = setInterval(loadMessages, 2000);
        }

        function showList() {
            currentTargetId = null;
            clearInterval(window.msgInterval);
            showScreen('list-screen');
        }

        function showSettings() { showScreen('settings-screen'); }

        function saveSettings() {
            const pin = document.getElementById('setPin').value;
            if(pin.length === 4) {
                localStorage.setItem('app_pin_' + myId, pin);
                alert('PIN saved!');
            } else {
                localStorage.removeItem('app_pin_' + myId);
                alert('PIN removed');
            }
        }

        async function sendMessage() {
            const text = document.getElementById('msgText').value;
            if(!text) return;
            await fetch('/api/messages', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({fromId: myId, toId: currentTargetId, text})
            });
            document.getElementById('msgText').value = '';
            loadMessages();
        }

        async function loadMessages() {
            if(!currentTargetId) return;
            const res = await fetch(`/api/messages/${myId}/${currentTargetId}`);
            const messages = await res.json();
            const history = document.getElementById('chat-history');
            history.innerHTML = messages.map(m => `
                <div class="message ${m.fromId === myId ? 'msg-my' : 'msg-their'}">${m.text}</div>
            `).join('');
            history.scrollTop = history.scrollHeight;
        }

        async function applyLambda() {
            await fetch('/api/lambda', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id: myId}) });
            alert('Œª activated!');
        }
    </script>
</body>
</html>

